"use strict";(self.webpackChunkCRIS=self.webpackChunkCRIS||[]).push([[3662],{550:(oe,E,e)=>{function R(){return[1,0,0,0,1,0,0,0,1]}function A(v,S,N,K,X,J,$,w,U){return[v,S,N,K,X,J,$,w,U]}function j(v,S){return new Float64Array(v,S,9)}e.d(E,{a:()=>R,c:()=>j,f:()=>A}),Object.freeze(Object.defineProperty({__proto__:null,clone:function T(v){return[v[0],v[1],v[2],v[3],v[4],v[5],v[6],v[7],v[8]]},create:R,createView:j,fromValues:A},Symbol.toStringTag,{value:"Module"}))},53662:(oe,E,e)=>{e.r(E),e.d(E,{default:()=>Je});var R=e(15861),T=e(17626),U=(e(29132),e(88879),e(4832),e(49067),e(96794),e(69747),e(40425),e(69357),e(40342),e(73640),e(33474),e(63290)),de=(e(20383),e(74333)),ve=(e(8314),e(88159)),me=e(10699),c=e(32917),b=e(77712),fe=(e(90912),e(85931),e(76898)),ce=e(65401),ye=e(33190),ue=e(11519),q=e(17732),ge=e(26584),pe=(e(50618),e(2345),e(59318),e(84792),e(21726),e(52884),e(57477)),P=(e(68258),e(61885),e(21286)),k=e(80738),Re=(e(2172),e(39406)),B=(e(43987),e(67709),e(87526),e(11176),e(67969)),_=(e(81653),e(20194),e(39351),e(4619),e(18716),e(17807),e(61417),e(20468),e(34084),e(83994)),ee=(e(85775),e(72787),e(18952)),Te=e(49353),xe=(e(64887),e(93292),e(21596),e(23482),e(5254),e(1268),e(9545)),Ve=(e(919),e(31656),e(35903),e(37977),e(67910),e(60233),e(23282),e(8017),e(22796),e(2078),e(17625),e(36161),e(88569),e(7160),e(80576),e(78209),e(28082),e(11915),e(82054),e(16730),e(21254),e(14658)),Me=e(93555),Ce=(e(29289),e(59213),e(18142),e(9598),e(58098),e(8480)),Ee=e(79527),Se=e(17770),te=e(62208),Ue=e(88070),Pe=e(550),Ge=e(67831),De=e(99770),H=e(7547),Le=e(34106),Oe=e(31548);const x=(0,Pe.a)(),Ae={none:H.of.None,loop:H.of.Loop,oscillate:H.of.Oscillate};class Be extends pe.s{constructor(t){super(),this.elementView=t,this.isWrapAround=!1,this.perspectiveTransform=(0,De.a)(),this._playHandle=null,this._vertices=new Float32Array(20),this._handles=[],this._handles.push((0,c.YP)(()=>this.elementView.element.opacity,s=>this.opacity=s,c.nn),(0,c.YP)(()=>[this.elementView.coords],()=>{this.requestRender()},c.nn),(0,c.YP)(()=>["animationOptions"in this.elementView.element&&this.elementView.element.animationOptions],()=>{this._playHandle?.remove(),this.texture=(0,te.M2)(this.texture),this.requestRender()},c.nn),(0,c.gx)(()=>this.elementView.element.loaded,()=>{const s=this.elementView.element;this.ready(),"video"===s.type&&null!=s.content&&this._handles.push((0,Se.on)(s.content,"play",()=>this.requestRender()))},c.nn)),t.element.load().catch(s=>{U.Z.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new ge.Z("element-load-error","Element cannot be displayed",{element:t,error:s}))})}destroy(){this._playHandle?.remove(),this._handles.forEach(t=>t.remove()),this.texture=(0,te.M2)(this.texture)}get dvsMat3(){return this.parent.dvsMat3}beforeRender(t){const{context:s}=t,r=this.elementView.element.content;if(null!=r){const i=r instanceof HTMLImageElement,l=r instanceof HTMLVideoElement,a=i?r.naturalWidth:l?r.videoWidth:r.width,o=i?r.naturalHeight:l?r.videoHeight:r.height;if(this._updatePerspectiveTransform(a,o),this.texture)l&&!r.paused&&(this.texture.setData(r),this.requestRender(),(s.type===k.zO.WEBGL2||(0,P.wt)(a)&&(0,P.wt)(o))&&this.texture.generateMipmap());else{const m=new Oe.X;if(m.wrapMode=B.e8.CLAMP_TO_EDGE,m.preMultiplyAlpha=!0,m.width=a,m.height=o,"getFrame"in r){const d=h=>{this.texture?this.texture.setData(h):this.texture=new ee.x(s,m,h),this.requestRender()};"animationOptions"in this.elementView.element&&(this._playHandle=(0,Le.hY)(r,function je(n){return n?{...n,playAnimation:n.playing,repeatType:n.repeatType?Ae[n.repeatType]:void 0}:{}}(this.elementView.element.animationOptions),null,d))}else this.texture=new ee.x(s,m,r);(s.type===k.zO.WEBGL2||(0,P.wt)(a)&&(0,P.wt)(o))&&this.texture.generateMipmap(),l&&!r.paused&&this.requestRender()}}super.beforeRender(t)}_createTransforms(){return null}updateDrawCoords(t,s){const r=this.elementView.coords;if(null==r)return;const[i,l,a,o]=r.rings[0],m=this._vertices,{x:d,y:h}=t,u=0!==s;m.set(u?[l[0]-d,l[1]-h,i[0]-d,i[1]-h,a[0]-d,a[1]-h,o[0]-d,o[1]-h,o[0]-d,o[1]-h,l[0]+s-d,l[1]-h,l[0]+s-d,l[1]-h,i[0]+s-d,i[1]-h,a[0]+s-d,a[1]-h,o[0]+s-d,o[1]-h]:[l[0]-d,l[1]-h,i[0]-d,i[1]-h,a[0]-d,a[1]-h,o[0]-d,o[1]-h]),this.isWrapAround=u}getVAO(t,s,r){if(null==this.elementView.coords)return null;const i=this._vertices;if(this._vao)this._geometryVbo.setData(i);else{this._geometryVbo=_.f.createVertex(t,B.l1.DYNAMIC_DRAW,i);const l=_.f.createVertex(t,B.l1.STATIC_DRAW,new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]));this._vao=new Te.U(t,r,s,{geometry:this._geometryVbo,tex:l})}return this._vao}_updatePerspectiveTransform(t,s){const r=this._vertices;(0,Ue.E)(x,[0,0,t,0,0,s,t,s],[r[0],r[1],r[4],r[5],r[2],r[3],r[6],r[7]]),(0,Ge.s)(this.perspectiveTransform,x[6]/x[8]*t,x[7]/x[8]*s)}}var He=e(23841),V=e(30217),Ie=e(49966),We=e(37053),ze=e(24926),Ze=e(93548),Qe=e(44589);class Fe extends Qe.Z{constructor(){super(...arguments),this._localOrigin=(0,He.vW)(0,0),this._viewStateId=-1,this._dvsMat3=(0,Ie.c)()}get dvsMat3(){return this._dvsMat3}beforeRender(t){this._updateMatrices(t),this._updateOverlays(t,this.children);for(const s of this.children)s.beforeRender(t)}prepareRenderPasses(t){const s=t.registerRenderPass({name:"overlay",brushes:[Ze.U.overlay],target:()=>this.children,drawPhase:Re.jx.MAP});return[...super.prepareRenderPasses(t),s]}_updateMatrices(t){const{state:s}=t,{id:r,size:i,pixelRatio:l,resolution:a,rotation:o,viewpoint:m,displayMat3:d}=s;if(this._viewStateId===r)return;const h=Math.PI/180*o,u=l*i[0],p=l*i[1],{x:I,y:G}=m.targetGeometry,W=(0,Me.or)(I,s.spatialReference);this._localOrigin.x=W,this._localOrigin.y=G;const z=a*u,D=a*p,f=(0,V.g)(this._dvsMat3);(0,V.m)(f,f,d),(0,V.h)(f,f,(0,xe.f)(u/2,p/2)),(0,V.c)(f,f,(0,Ve.f)(u/z,-p/D,1)),(0,V.r)(f,f,-h),this._viewStateId=r}_updateOverlays(t,s){const{state:r}=t,{rotation:i,spatialReference:l,worldScreenWidth:a,size:o,viewpoint:m}=r,d=this._localOrigin;let h=0;const u=(0,We.C5)(l);if(u&&l.isWrappable){const p=o[0],I=o[1],G=180/Math.PI*i,W=Math.abs(Math.cos(G)),z=Math.abs(Math.sin(G)),D=Math.round(p*W+I*z),[f,Z]=u.valid,g=(0,ze.ut)(l),{x:ne,y:$e}=m.targetGeometry,Q=[0,0];r.toScreen(Q,[ne,$e]);const L=[0,0];let F;F=D>a?.5*a:.5*D;const re=Math.floor((ne+.5*g)/g),be=f+re*g,qe=Z+re*g,Y=[Q[0]+F,0];r.toMap(L,Y),L[0]>qe&&(h=g),Y[0]=Q[0]-F,r.toMap(L,Y),L[0]<be&&(h=-g);for(const O of s){const ie=O.elementView.bounds;if(null==ie)continue;const[ae,,le]=ie;O.updateDrawCoords(d,ae<f&&le>f?g:le>Z&&ae<Z?-g:h)}}else for(const p of s)p.updateDrawCoords(d,h)}}var Ye=e(37384),Ne=e(45611),Ke=e(2004);let M=class extends((0,Ye.y)(Ne.Z)){constructor(){super(...arguments),this._overlayContainer=null,this._fetchQueue=null,this._tileStrategy=null,this._elementReferences=new Map,this._debugGraphicsView=null,this.layer=null,this.elements=new de.Z}attach(){this.addAttachHandles([(0,c.on)(()=>this.layer.effectiveSource,"refresh",()=>{this._tileStrategy.refresh(n=>this._updateTile(n)),this.requestUpdate()}),(0,c.on)(()=>this.layer.effectiveSource,"change",({element:n})=>this._elementUpdateHandler(n))]),this._overlayContainer=new Fe,this.container.addChild(this._overlayContainer),this._fetchQueue=new Ce.Z({tileInfoView:this.view.featuresTilingScheme,concurrency:10,process:(n,t)=>this._queryElements(n,t)}),this._tileStrategy=new Ee.Z({cachePolicy:"purge",resampling:!0,acquireTile:n=>this._acquireTile(n),releaseTile:n=>this._releaseTile(n),tileInfoView:this.view.featuresTilingScheme}),this.requestUpdate()}detach(){this.elements.removeAll(),this._tileStrategy.destroy(),this._fetchQueue.destroy(),this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this._elementReferences.clear(),this._debugGraphicsView?.destroy()}supportsSpatialReference(n){return!0}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}update(n){this._tileStrategy.update(n),this._debugGraphicsView?.update(n)}hitTest(n,t){var s=this;return(0,R.Z)(function*(){const r=[],i=n.normalize(),l=[i.x,i.y];for(const{projectedElement:{normalizedCoords:a,element:o}}of s._elementReferences.values())null!=a&&(0,ye.wP)(a.rings,l)&&r.push({type:"media",element:o,layer:s.layer,mapPoint:n,sourcePoint:o.toSource(n)});return r.reverse()})()}canResume(){return null!=this.layer.source&&super.canResume()}doRefresh(){var n=this;return(0,R.Z)(function*(){n._fetchQueue.reset(),n._tileStrategy.refresh(t=>n._updateTile(t))})()}_acquireTile(n){const t=new Xe(n.clone());return this._updateTile(t),t}_updateTile(n){this._updatingHandles.addPromise(this._fetchQueue.push(n.key).then(t=>{const[s,r]=n.setElements(t);this._referenceElements(n,s),this._dereferenceElements(n,r),this.requestUpdate()},t=>{(0,me.D_)(t)||U.Z.getLogger(this).error(t)}))}_releaseTile(n){this._fetchQueue.abort(n.key.id),n.elements&&this._dereferenceElements(n,n.elements),this.requestUpdate()}_queryElements(n,t){var s=this;return(0,R.Z)(function*(){const r=s.layer.effectiveSource;if(null==r)return[];s.view.featuresTilingScheme.getTileBounds(y,n,!0);const i=new Ke.Z({xmin:y[0],ymin:y[1],xmax:y[2],ymax:y[3],spatialReference:s.view.spatialReference});return r.queryElements(i,t)})()}_referenceElements(n,t){if(null!=this.layer.source)for(const s of t)this._referenceElement(n,s)}_referenceElement(n,t){(0,ve.s1)(this._elementReferences,t.uid,()=>{const s=new q.L({element:t,spatialReference:this.view.spatialReference}),r=new Be(s);return this._overlayContainer.addChild(r),this.elements.add(t),{tiles:new Set,projectedElement:s,overlay:r,debugGraphic:null}}).tiles.add(n)}_dereferenceElements(n,t){for(const s of t)this._dereferenceElement(n,s)}_dereferenceElement(n,t){const s=this._elementReferences.get(t.uid);s.tiles.delete(n),s.tiles.size||(this._overlayContainer.removeChild(s.overlay),s.overlay.destroy(),s.projectedElement.destroy(),this._elementReferences.delete(t.uid),this.elements.remove(t),this._debugGraphicsView?.graphics.remove(s.debugGraphic))}_elementUpdateHandler(n){let t=this._elementReferences.get(n.uid);if(t){const r=t.projectedElement.normalizedCoords;if(null==r)return this._overlayContainer.removeChild(t.overlay),t.overlay.destroy(),t.projectedElement.destroy(),this._elementReferences.delete(n.uid),this.elements.remove(n),void this._debugGraphicsView?.graphics.remove(t.debugGraphic);const i=[],l=[];for(const a of this._tileStrategy.tiles){const o=se(this.view.featuresTilingScheme,a,r);t.tiles.has(a)?o||l.push(a):o&&i.push(a)}for(const a of i)this._referenceElement(a,n);for(const a of l)this._dereferenceElement(a,n);return t=this._elementReferences.get(n.uid),void(t?.debugGraphic&&(t.debugGraphic.geometry=t.projectedElement.normalizedCoords,this._debugGraphicsView.graphicUpdateHandler({graphic:t.debugGraphic,property:"geometry"})))}const s=new q.L({element:n,spatialReference:this.view.spatialReference}).normalizedCoords;if(null!=s)for(const r of this._tileStrategy.tiles)se(this.view.featuresTilingScheme,r,s)&&this._referenceElement(r,n)}};(0,T._)([(0,b.Cb)()],M.prototype,"layer",void 0),(0,T._)([(0,b.Cb)({readOnly:!0})],M.prototype,"elements",void 0),M=(0,T._)([(0,fe.j)("esri.views.2d.layers.MediaLayerView2D")],M);const y=(0,ce.Ue)(),C={xmin:0,ymin:0,xmax:0,ymax:0};function se(n,t,s){return n.getTileBounds(y,t.key,!0),C.xmin=y[0],C.ymin=y[1],C.xmax=y[2],C.ymax=y[3],(0,ue.Nl)(C,s)}class Xe{constructor(t){this.key=t,this.elements=null,this.isReady=!1,this.visible=!0}setElements(t){const s=[],r=new Set(this.elements);this.elements=t;for(const i of t)r.has(i)?r.delete(i):s.push(i);return this.isReady=!0,[s,Array.from(r)]}destroy(){}}const Je=M}}]);