"use strict";(self.webpackChunkCRIS=self.webpackChunkCRIS||[]).push([[4622],{71379:(W,M,_)=>{_.d(M,{s:()=>L});var r=_(65401),h=_(49966),f=_(90301),c=_(43783);class o extends c.I{constructor(i,l,E,d,P,C,u=null){super(i,l,E,d,P,C),this.bitmap=new f.eY(u),this.bitmap.coordScale=[P,C],this.bitmap.once("isReady",()=>this.ready())}destroy(){super.destroy(),this.bitmap.destroy()}beforeRender(i){this.bitmap.beforeRender(i),super.beforeRender(i)}afterRender(i){this.bitmap.afterRender(i),super.afterRender(i)}set stencilRef(i){this.bitmap.stencilRef=i}get stencilRef(){return this.bitmap.stencilRef}_createTransforms(){return{dvs:(0,h.c)(),tileMat3:(0,h.c)()}}setTransform(i){super.setTransform(i),this.bitmap.transforms.dvs=this.transforms.dvs}onAttach(){this.bitmap.stage=this.stage}onDetach(){this.bitmap&&(this.bitmap.stage=null)}}var O=_(93548),U=_(39406),B=_(26268);class L extends B.Z{get requiresDedicatedFBO(){return this.children.some(i=>"additive"===i.bitmap.blendFunction)}createTile(i){const l=this._tileInfoView.getTileBounds((0,r.Ue)(),i),E=this._tileInfoView.getTileResolution(i.level),[d,P]=this._tileInfoView.tileInfo.size;return new o(i,E,l[0],l[3],d,P)}prepareRenderPasses(i){const l=i.registerRenderPass({name:"bitmap (tile)",brushes:[O.U.bitmap],target:()=>this.children.map(E=>E.bitmap),drawPhase:U.jx.MAP});return[...super.prepareRenderPasses(i),l]}doRender(i){this.visible&&i.drawPhase===U.jx.MAP&&super.doRender(i)}}},41310:(W,M,_)=>{_.r(M),_.d(M,{default:()=>N});var r=_(15861),h=_(17626),f=_(54024),c=_(63290),o=_(10699),O=_(77712),R=(_(90912),_(85931),_(8314),_(76898)),i=_(37053),l=_(51815),y=(_(26584),_(50618),_(2345),_(59318),_(84792),_(21726),_(52884),_(57477),_(68258),_(61885),_(21286),_(80738),_(2172),_(39406),_(43987),_(67709),_(87526),_(11176),_(67969),_(81653),_(20194),_(39351),_(4619),_(18716),_(17807),_(61417),_(20468),_(34084),_(83994),_(85775),_(72787),_(18952),_(49353),_(64887),_(93292),_(21596),_(23482),_(5254),_(1268),_(9545),_(919),_(31656),_(35903),_(37977),_(67910),_(60233),_(23282),_(8017),_(22796),_(2078),_(17625),_(36161),_(88569),_(7160),_(80576),_(78209)),V=(_(28082),_(59213),_(74333),_(30755),_(819),_(11915),_(82054),_(16730),_(21254),_(14658),_(93555),_(29289),_(18142),_(91082)),S=_(37384),H=_(13305),v=_(88893),G=_(9598),p=_(58098),Z=_(8480),F=_(79527),Q=_(45611),x=_(94421),A=_(84537),w=_(94672);const z=[0,0];let g=class extends((0,x.Z)((0,V.Y)((0,S.y)(Q.Z)))){constructor(){super(...arguments),this._fetchQueue=null,this._highlightGraphics=new l.J,this._highlightView=null,this._popupHighlightHelper=null,this._tileStrategy=null,this.layer=null}get resampling(){return!("resampling"in this.layer)||!1!==this.layer.resampling}get tilemapCache(){return"tilemapCache"in this.layer?this.layer.tilemapCache:null}update(e){this._fetchQueue.pause(),this._fetchQueue.state=e.state,this._tileStrategy.update(e),this._fetchQueue.resume(),this._highlightView?.processUpdate(e)}attach(){const e="tileServers"in this.layer?this.layer.tileServers:null,s=this.tilemapCache;if(this._tileInfoView=new G.Z(this.layer.tileInfo,this.layer.fullExtent,s?.effectiveMinLOD,s?.effectiveMaxLOD),this._fetchQueue=new Z.Z({tileInfoView:this._tileInfoView,concurrency:e&&10*e.length||10,process:(t,n)=>this.fetchTile(t,n)}),this._tileStrategy=new F.Z({cachePolicy:"keep",resampling:this.resampling,acquireTile:t=>this.acquireTile(t),releaseTile:t=>this.releaseTile(t),tileInfoView:this._tileInfoView}),(0,A.Uf)(this,this.layer)){const t=this._highlightView=new y.Z({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new H.Z(this.view.featuresTilingScheme),defaultPointSymbolEnabled:!1});this.container.addChild(this._highlightView.container),this._popupHighlightHelper=new A.VF({createFetchPopupFeaturesQueryGeometry:(n,a)=>(0,w.K)(n,a,this.view),highlightGraphics:this._highlightGraphics,highlightGraphicUpdated:(n,a)=>{t.graphicUpdateHandler({graphic:n,property:a})},layerView:this,updatingHandles:this._updatingHandles})}this.requestUpdate(),this.addAttachHandles(this._updatingHandles.add(()=>this.resampling,()=>{this.doRefresh()})),super.attach()}detach(){super.detach(),this._tileStrategy.destroy(),this._fetchQueue.clear(),this.container.removeAllChildren(),this._popupHighlightHelper?.destroy(),this._highlightView?.destroy(),this._fetchQueue=this._tileStrategy=this._tileInfoView=this._popupHighlightHelper=null}fetchPopupFeatures(e,s){var t=this;return(0,r.Z)(function*(){return t._popupHighlightHelper?t._popupHighlightHelper.fetchPopupFeatures(e,s):[]})()}highlight(e){return this._popupHighlightHelper?this._popupHighlightHelper.highlight(e):(0,f.kB)()}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}supportsSpatialReference(e){return(0,i.fS)(this.layer.tileInfo?.spatialReference,e)}doRefresh(){var e=this;return(0,r.Z)(function*(){if(e.attached){if(e.suspended)return e._tileStrategy.clear(),void e.requestUpdate();e._fetchQueue.reset(),e._tileStrategy.refresh(s=>e._updatingHandles.addPromise(e._enqueueTileFetch(s)))}})()}acquireTile(e){const s=this._bitmapView.createTile(e),t=s.bitmap;return[t.x,t.y]=this._tileInfoView.getTileCoords(z,s.key),t.resolution=this._tileInfoView.getTileResolution(s.key),[t.width,t.height]=this._tileInfoView.tileInfo.size,this._updatingHandles.addPromise(this._enqueueTileFetch(s)),this._bitmapView.addChild(s),this.requestUpdate(),s}releaseTile(e){this._fetchQueue.abort(e.key.id),this._bitmapView.removeChild(e),e.once("detach",()=>e.destroy()),this.requestUpdate()}fetchTile(e,s={}){var t=this;return(0,r.Z)(function*(){const n=t.tilemapCache,{signal:a,resamplingLevel:m=0}=s;if(!n)try{return yield t._fetchImage(e,a)}catch(D){if(!(0,o.D_)(D)&&!t.resampling)return(0,v.V)(t._tileInfoView.tileInfo.size);if(m<3){const j=t._tileInfoView.getTileParentId(e.id);if(j){const K=new p.Z(j),Y=yield t.fetchTile(K,{...s,resamplingLevel:m+1});return(0,v.i)(t._tileInfoView,Y,K,e)}}throw D}const T=new p.Z(0,0,0,0);let I;try{if(yield n.fetchAvailabilityUpsample(e.level,e.row,e.col,T,{signal:a}),T.level!==e.level&&!t.resampling)return(0,v.V)(t._tileInfoView.tileInfo.size);I=yield t._fetchImage(T,a)}catch(D){if((0,o.D_)(D))throw D;I=yield t._fetchImage(e,a)}return t.resampling?(0,v.i)(t._tileInfoView,I,T,e):I})()}_enqueueTileFetch(e){var s=this;return(0,r.Z)(function*(){if(!s._fetchQueue.has(e.key.id)){try{const t=yield s._fetchQueue.push(e.key);e.bitmap.source=t,e.bitmap.width=s._tileInfoView.tileInfo.size[0],e.bitmap.height=s._tileInfoView.tileInfo.size[1],e.once("attach",()=>s.requestUpdate())}catch(t){(0,o.D_)(t)||c.Z.getLogger(s).error(t)}s.requestUpdate()}})()}_fetchImage(e,s){var t=this;return(0,r.Z)(function*(){return t.layer.fetchImageBitmapTile(e.level,e.row,e.col,{signal:s})})()}};(0,h._)([(0,O.Cb)()],g.prototype,"resampling",null),(0,h._)([(0,O.Cb)()],g.prototype,"tilemapCache",null),g=(0,h._)([(0,R.j)("esri.views.2d.layers.TileLayerView2D")],g);const N=g}}]);