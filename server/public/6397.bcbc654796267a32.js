"use strict";(self.webpackChunkCRIS=self.webpackChunkCRIS||[]).push([[6397],{65389:(W,L,a)=>{a.d(L,{Z:()=>u});class u{constructor(b){this.size=0,this._start=0,this.maxSize=b,this._buffer=new Array(b)}get entries(){return this._buffer}enqueue(b){if(this.size===this.maxSize){const c=this._buffer[this._start];return this._buffer[this._start]=b,this._start=(this._start+1)%this.maxSize,c}return this._buffer[(this._start+this.size++)%this.maxSize]=b,null}dequeue(){if(0===this.size)return null;const b=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,b}peek(){return 0===this.size?null:this._buffer[this._start]}find(b){if(0===this.size)return null;for(const c of this._buffer)if(null!=c&&b(c))return c;return null}clear(b){let c=this.dequeue();for(;null!=c;)b&&b(c),c=this.dequeue()}}},90301:(W,L,a)=>{a.d(L,{JZ:()=>A,RL:()=>F,eY:()=>H});var u=a(15861),d=a(10699),b=a(30217),c=a(49966),U=a(9545),O=a(57477),m=a(14403),w=a(80738),p=a(67969),E=a(18952),x=a(31548);function A(R){return R&&"render"in R}function F(R){const l=document.createElement("canvas");return l.width=R.width,l.height=R.height,R.render(l.getContext("2d")),l}class H extends O.s{constructor(l=null,h=!1){super(),this.blendFunction="standard",this._sourceWidth=0,this._sourceHeight=0,this._textureInvalidated=!1,this._texture=null,this.stencilRef=0,this.coordScale=[1,1],this._height=void 0,this.pixelRatio=1,this.resolution=0,this.rotation=0,this._source=null,this._width=void 0,this.x=0,this.y=0,this.immutable=h,this.source=l,this.requestRender=this.requestRender.bind(this)}destroy(){this._texture&&(this._texture.dispose(),this._texture=null),null!=this._uploadStatus&&(this._uploadStatus.controller.abort(),this._uploadStatus=null)}get isSourceScaled(){return this.width!==this._sourceWidth||this.height!==this._sourceHeight}get height(){return void 0!==this._height?this._height:this._sourceHeight}set height(l){this._height=l}get source(){return this._source}set source(l){null==l&&null==this._source||(this._source=l,this.invalidateTexture(),this.requestRender())}get width(){return void 0!==this._width?this._width:this._sourceWidth}set width(l){this._width=l}beforeRender(l){super.beforeRender(l),this.updateTexture(l)}setSourceAsync(l,h){var f=this;return(0,u.Z)(function*(){null!=f._uploadStatus&&f._uploadStatus.controller.abort();const T=new AbortController,B=(0,d.hh)();return(0,d.$F)(h,()=>T.abort()),(0,d.$F)(T,M=>B.reject(M)),f._uploadStatus={controller:T,resolver:B},f.source=l,B.promise})()}invalidateTexture(){this._textureInvalidated||(this._textureInvalidated=!0,this._source instanceof HTMLImageElement?(this._sourceHeight=this._source.naturalHeight,this._sourceWidth=this._source.naturalWidth):this._source&&(this._sourceHeight=this._source.height,this._sourceWidth=this._source.width))}updateTransitionProperties(l,h){l>=64&&(this.fadeTransitionEnabled=!1,this.inFadeTransition=!1),super.updateTransitionProperties(l,h)}setTransform(l){const h=(0,b.g)(this.transforms.dvs),[f,T]=l.toScreenNoRotation([0,0],[this.x,this.y]),B=this.resolution/this.pixelRatio/l.resolution,M=B*this.width,V=B*this.height,P=Math.PI*this.rotation/180;(0,b.h)(h,h,(0,U.f)(f,T)),(0,b.h)(h,h,(0,U.f)(M/2,V/2)),(0,b.r)(h,h,-P),(0,b.h)(h,h,(0,U.f)(-M/2,-V/2)),(0,b.l)(h,h,(0,U.f)(M,V)),(0,b.m)(this.transforms.dvs,l.displayViewMat3,h)}setSamplingProfile(l){this._texture&&(l.mips&&!this._texture.descriptor.hasMipmap&&this._texture.generateMipmap(),this._texture.setSamplingMode(l.samplingMode))}bind(l,h){this._texture&&l.bindTexture(this._texture,h)}updateTexture({context:l,painter:h}){var f=this;return(0,u.Z)(function*(){if(!f._textureInvalidated)return;if(f._textureInvalidated=!1,f._texture||(f._texture=f._createTexture(l)),!f.source)return void f._texture.setData(null);f._texture.resize(f._sourceWidth,f._sourceHeight);const T=function q(R){return A(R)?R instanceof m.Z?R.getRenderedRasterPixels()?.renderedRasterPixels:F(R):R}(f.source);try{if(null!=f._uploadStatus){const{controller:B,resolver:M}=f._uploadStatus,V={signal:B.signal},{width:P,height:N}=f,k=f._texture;yield h.textureUploadManager.enqueueTextureUpdate({data:T,texture:k,width:P,height:N},V),M.resolve(),f._uploadStatus=null}else f._texture.setData(T);f.ready()}catch(B){(0,d.H9)(B)}})()}onDetach(){this.destroy()}_createTransforms(){return{dvs:(0,c.c)()}}_createTexture(l){const h=this.immutable&&l.type===w.zO.WEBGL2,f=new x.X;return f.internalFormat=h?p.lP.RGBA8:p.VI.RGBA,f.wrapMode=p.e8.CLAMP_TO_EDGE,f.isImmutable=h,f.width=this._sourceWidth,f.height=this._sourceHeight,new E.x(l,f)}}},71379:(W,L,a)=>{a.d(L,{s:()=>p});var u=a(65401),d=a(49966),b=a(90301),c=a(43783);class U extends c.I{constructor(x,A,F,q,H,R,l=null){super(x,A,F,q,H,R),this.bitmap=new b.eY(l),this.bitmap.coordScale=[H,R],this.bitmap.once("isReady",()=>this.ready())}destroy(){super.destroy(),this.bitmap.destroy()}beforeRender(x){this.bitmap.beforeRender(x),super.beforeRender(x)}afterRender(x){this.bitmap.afterRender(x),super.afterRender(x)}set stencilRef(x){this.bitmap.stencilRef=x}get stencilRef(){return this.bitmap.stencilRef}_createTransforms(){return{dvs:(0,d.c)(),tileMat3:(0,d.c)()}}setTransform(x){super.setTransform(x),this.bitmap.transforms.dvs=this.transforms.dvs}onAttach(){this.bitmap.stage=this.stage}onDetach(){this.bitmap&&(this.bitmap.stage=null)}}var O=a(93548),m=a(39406),w=a(26268);class p extends w.Z{get requiresDedicatedFBO(){return this.children.some(x=>"additive"===x.bitmap.blendFunction)}createTile(x){const A=this._tileInfoView.getTileBounds((0,u.Ue)(),x),F=this._tileInfoView.getTileResolution(x.level),[q,H]=this._tileInfoView.tileInfo.size;return new U(x,F,A[0],A[3],q,H)}prepareRenderPasses(x){const A=x.registerRenderPass({name:"bitmap (tile)",brushes:[O.U.bitmap],target:()=>this.children.map(F=>F.bitmap),drawPhase:m.jx.MAP});return[...super.prepareRenderPasses(x),A]}doRender(x){this.visible&&x.drawPhase===m.jx.MAP&&super.doRender(x)}}},47123:(W,L,a)=>{a.d(L,{T:()=>H});var u=a(15861),d=a(10699),b=a(35133),c=a(28082),U=a(26268),O=a(23841),m=a(16730),w=a(21254),p=a(87526),E=a(17807),x=a(25575),A=a(31637);function F(R,l){const h=l.length;if(R<l[0].value||1===h)return l[0].size;for(let f=1;f<h;f++)if(R<l[f].value)return l[f-1].size+(R-l[f-1].value)/(l[f].value-l[f-1].value)*(l[f].size-l[f-1].size);return l[h-1].size}class q{constructor(){this.symbolLevels=[],this.vvColorValues=new Float32Array(8),this.vvColors=new Float32Array(32),this.vvOpacityValues=new Float32Array(8),this.vvOpacities=new Float32Array(8),this.vvSizeMinMaxValue=new Float32Array(4),this.outsideLabelsVisible=!1,this._vvMaterialParameters={vvSizeEnabled:!1,vvColorEnabled:!1,vvRotationEnabled:!1,vvRotationType:"geographic",vvOpacityEnabled:!1},this._technique=E.v}getSizeVVFieldStops(l){const h=this._vvSizeFieldStops;if(h)switch(h.type){case"static":return h;case"level-dependent":return h.levels[l]??(()=>{let f=1/0,T=0;for(const P in h.levels){const N=parseFloat(P),k=Math.abs(l-N);k<f&&(f=k,T=N)}if(f===1/0)return{sizes:new Float32Array([0,0,0,0,0,0]),values:new Float32Array([0,0,0,0,0,0])};const B=2**((l-T)/2),M=h.levels[T],V=new Float32Array(M.values);return V[2]*=B,V[3]*=B,{sizes:M.sizes,values:V}})();default:return}}get vvMaterialParameters(){return this._vvMaterialParameters}update(l){null!=this._vvInfo&&this._updateVisualVariables(this._vvInfo.vvRanges,l)}setInfo(l,h,f){this._updateEffects(f),this._vvInfo=h,this._technique=(0,x.EJ)(l),this.rendererSchema=this._technique.createOrUpdateRendererSchema(this.rendererSchema,l)}getVariation(){return{...this._technique.getVariation(this.rendererSchema),outsideLabelsVisible:this.outsideLabelsVisible,supportsTextureFloat:(0,A.hc)("2d").supportsTextureFloat}}getVariationHash(){return this._technique.getVariationHash(this.rendererSchema)<<1|(this.outsideLabelsVisible?1:0)}_updateEffects(l){this.outsideLabelsVisible=null!=l&&l.excludedLabelsVisible}_updateVisualVariables(l,h){const f=this._vvMaterialParameters;if(f.vvOpacityEnabled=!1,f.vvSizeEnabled=!1,f.vvColorEnabled=!1,f.vvRotationEnabled=!1,!l)return;const T=l.size;if(T){if(f.vvSizeEnabled=!0,T.minMaxValue){const P=T.minMaxValue;let N,k;if((0,p.$K)(P.minSize)&&(0,p.$K)(P.maxSize))if((0,p.hj)(P.minSize)&&(0,p.hj)(P.maxSize))N=(0,O.F2)(P.minSize),k=(0,O.F2)(P.maxSize);else{const Y=h.scale;N=(0,O.F2)(F(Y,P.minSize.stops)),k=(0,O.F2)(F(Y,P.maxSize.stops))}this.vvSizeMinMaxValue.set([P.minDataValue,P.maxDataValue,N,k])}if(T.scaleStops&&(this.vvSizeScaleStopsValue=(0,O.F2)(F(h.scale,T.scaleStops.stops))),T.unitValue){const P=(0,m.c9)(h.spatialReference)/w.a[T.unitValue.unit];this.vvSizeUnitValueToPixelsRatio=P/h.resolution}T.fieldStops&&(this._vvSizeFieldStops=T.fieldStops)}const B=l.color;B&&(f.vvColorEnabled=!0,this.vvColorValues.set(B.values),this.vvColors.set(B.colors));const M=l.opacity;M&&(f.vvOpacityEnabled=!0,this.vvOpacityValues.set(M.values),this.vvOpacities.set(M.opacities));const V=l.rotation;V&&(f.vvRotationEnabled=!0,f.vvRotationType=V.type)}}class H extends U.Z{constructor(l){super(l),this._rendererInfo=new q,this._materialItemsRequestQueue=new b.Z,this.attributeView=new c.H(()=>this.onAttributeStoreUpdate())}destroy(){this.children.forEach(l=>l.destroy()),this.removeAllChildren(),this.attributeView.destroy(),this._materialItemsRequestQueue.clear()}setRendererInfo(l,h,f){this._rendererInfo.setInfo(l,h,f),this.requestRender()}getMaterialItems(l,h){var f=this;return(0,u.Z)(function*(){if(!l||0===l.length)return[];const T=(0,d.hh)();return f._materialItemsRequestQueue.push({items:l,abortOptions:h,resolver:T}),f.requestRender(),T.promise})()}doRender(l){if(l.context.capabilities.enable("textureFloat"),l.context.capabilities.enable("vao"),this._materialItemsRequestQueue.length>0){let h=this._materialItemsRequestQueue.pop();for(;h;)this._processMaterialItemRequest(l,h),h=this._materialItemsRequestQueue.pop()}super.doRender(l)}renderChildren(l){for(const h of this.children)h.commit(l);this._rendererInfo.update(l.state),super.renderChildren(l)}createRenderParams(l){const h=super.createRenderParams(l);return h.rendererInfo=this._rendererInfo,h.attributeView=this.attributeView,h}onAttributeStoreUpdate(){}_processMaterialItemRequest(l,{items:h,abortOptions:f,resolver:T}){const{painter:B,pixelRatio:M}=l,V=h.map(P=>B.textureManager.rasterizeItem(P.symbol,M,P.glyphIds,f));Promise.all(V).then(P=>{if(!this.stage)return void T.reject();const N=P.map((k,Y)=>({id:h[Y].id,mosaicItem:k}));T.resolve(N)},T.reject)}}},14403:(W,L,a)=>{a.d(L,{Z:()=>u});class u{constructor(b,c,U){this.pixelBlock=b,this.extent=c,this.originalPixelBlock=U}get width(){return null!=this.pixelBlock?this.pixelBlock.width:0}get height(){return null!=this.pixelBlock?this.pixelBlock.height:0}render(b){const c=this.pixelBlock;if(null==c)return;const U=this.filter({extent:this.extent,pixelBlock:this.originalPixelBlock??c});if(null==U.pixelBlock)return;U.pixelBlock.maskIsAlpha&&(U.pixelBlock.premultiplyAlpha=!0);const O=U.pixelBlock.getAsRGBA(),m=b.createImageData(U.pixelBlock.width,U.pixelBlock.height);m.data.set(O),b.putImageData(m,0,0)}getRenderedRasterPixels(){const b=this.filter({extent:this.extent,pixelBlock:this.pixelBlock});return null==b.pixelBlock?null:(b.pixelBlock.maskIsAlpha&&(b.pixelBlock.premultiplyAlpha=!0),{width:b.pixelBlock.width,height:b.pixelBlock.height,renderedRasterPixels:new Uint8Array(b.pixelBlock.getAsRGBA().buffer)})}}},2172:(W,L,a)=>{a.d(L,{Q:()=>m,g:()=>U});var u=a(8314),d=a(62208),b=a(31823);const c=(0,u.Z)("esri-2d-log-allocations");class U{constructor(p,E){this._array=p,this._pool=E}get array(){return this._array}get length(){return this._array.length}static create(p,E){const x=E.acquire(p);return new U(x,E)}expand(p){const E=this._pool.acquire(p);E.set(this._array),this._pool.release(this._array),this._array=E}destroy(){this._pool.release(this._array)}set(p,E){this._array.set(p._array,E)}slice(){const p=this._pool.acquire(this._array.byteLength);return p.set(this._array),new U(p,this._pool)}}class O{constructor(){this._data=new ArrayBuffer(O.BYTE_LENGTH),this._freeList=new b.m({start:0,end:this._data.byteLength})}static get BYTE_LENGTH(){return 64e6}get buffer(){return this._data}allocate(p){const E=this._freeList.firstFit(p);return null==E?null:new Uint32Array(this._data,E,p/Uint32Array.BYTES_PER_ELEMENT)}free(p){this._freeList.free(p.byteOffset,p.byteLength)}}class m{constructor(){this._bytesAllocated=0,this._pages=[],this._pagesByBuffer=new Map,this._addPage()}destroy(){this._pages=[],this._pagesByBuffer=null}get _bytesTotal(){return this._pages.length*O.BYTE_LENGTH}acquire(p){if(this._bytesAllocated+=p,c&&console.log(`Allocating ${p}, (${this._bytesAllocated} / ${this._bytesTotal})`),p>O.BYTE_LENGTH)return new Uint32Array(p/Uint32Array.BYTES_PER_ELEMENT);for(const x of this._pages){const A=x.allocate(p);if(null!=A)return A}const E=this._addPage().allocate(p);return(0,d.O3)(E,"Expected to allocate page"),E}release(p){this._bytesAllocated-=p.byteLength,c&&console.log(`Freeing ${p.byteLength}, (${this._bytesAllocated} / ${this._bytesTotal})`);const E=this._pagesByBuffer.get(p.buffer);E&&E.free(p)}_addPage(){const p=new O;return this._pages.push(p),this._pagesByBuffer.set(p.buffer,p),p}}},26268:(W,L,a)=>{a.d(L,{Z:()=>m});var u=a(8314),d=a(39406),b=a(44589),c=a(8650),U=a(13382);const O=(w,p)=>w.key.level-p.key.level!=0?w.key.level-p.key.level:w.key.row-p.key.row!=0?w.key.row-p.key.row:w.key.col-p.key.col;class m extends b.Z{constructor(p){super(),this._tileInfoView=p}renderChildren(p){this.sortChildren(O),this.setStencilReference(p),super.renderChildren(p)}createRenderParams(p){const{state:E}=p,x=super.createRenderParams(p);return x.requiredLevel=this._tileInfoView.getClosestInfoForScale(E.scale).level,x.displayLevel=this._tileInfoView.tileInfo.scaleToZoom(E.scale),x}prepareRenderPasses(p){const E=super.prepareRenderPasses(p);return E.push(p.registerRenderPass({name:"stencil",brushes:[U.Z],drawPhase:d.jx.DEBUG|d.jx.MAP|d.jx.HIGHLIGHT,target:()=>this.getStencilTarget()})),(0,u.Z)("esri-tiles-debug")&&E.push(p.registerRenderPass({name:"tileInfo",brushes:[c.Z],drawPhase:d.jx.DEBUG,target:()=>this.children})),E}getStencilTarget(){return this.children}setStencilReference(p){let E=1;for(const x of this.children)x.stencilRef=E++}}},46397:(W,L,a)=>{a.r(L),a.d(L,{default:()=>kt});var u=a(15861),d=a(17626),b=a(88879),c=a(77712),O=(a(90912),a(85931)),m=a(8314),w=a(76898);let p=class extends b.Z{constructor(){super(...arguments),this.isAggregate=!0}getEffectivePopupTemplate(t=!1){if(this.popupTemplate)return this.popupTemplate;const e=this.sourceLayer?.featureReduction;return e&&"popupTemplate"in e&&e.popupEnabled?e.popupTemplate:null}getObjectId(){return this.attributes.aggregateId}};(0,d._)([(0,c.Cb)({type:Boolean})],p.prototype,"isAggregate",void 0),p=(0,d._)([(0,w.j)("esri.AggregateGraphic")],p);const E=p;a(29132);var A=a(74333),F=a(26584),q=a(54024),H=a(58817),R=a(63290),l=a(62208),h=a(10699),f=a(32917),T=a(23841),B=a(83761),M=a(52884);let V=class extends B.Z{constructor(t){super(t),this._filter=null,this.duration=(0,m.Z)("mapview-transitions-duration"),this._excludedEffectView=new M.AM(t),this._includedEffectView=new M.AM(t)}get excludedEffects(){return this._excludedEffectView.effects}set featureEffect(t){this._get("featureEffect")!==t&&this._transitionTo(t)}get filter(){return this._filter||this.featureEffect?.filter||null}get hasEffects(){return this._excludedEffectView.hasEffects||this._includedEffectView.hasEffects}get includedEffects(){return this._includedEffectView.effects}set scale(t){this._set("scale",t),this._excludedEffectView.scale=t,this._includedEffectView.scale=t}get transitioning(){return this._excludedEffectView.transitioning||this._includedEffectView.transitioning}transitionStep(t,e){this._set("scale",e),this.transitioning?(this._includedEffectView.transitionStep(t,e),this._excludedEffectView.transitionStep(t,e),this.transitioning||(this._filter=null)):(this._excludedEffectView.scale=e,this._includedEffectView.scale=e)}endTransitions(){this._includedEffectView.endTransitions(),this._excludedEffectView.endTransitions(),this._filter=null}_transitionTo(t){const e=this._get("featureEffect"),r=t,i=r?.includedEffect,s=r?.excludedEffect,n=this._includedEffectView.canTransitionTo(i)&&this._excludedEffectView.canTransitionTo(s);this._includedEffectView.effect=i,this._excludedEffectView.effect=s,this._set("featureEffect",r),this._filter=r?.filter||e?.filter||null,n||this.endTransitions()}};(0,d._)([(0,c.Cb)()],V.prototype,"_filter",void 0),(0,d._)([(0,c.Cb)()],V.prototype,"_excludedEffectView",void 0),(0,d._)([(0,c.Cb)()],V.prototype,"_includedEffectView",void 0),(0,d._)([(0,c.Cb)()],V.prototype,"duration",void 0),(0,d._)([(0,c.Cb)()],V.prototype,"excludedEffects",null),(0,d._)([(0,c.Cb)()],V.prototype,"featureEffect",null),(0,d._)([(0,c.Cb)()],V.prototype,"filter",null),(0,d._)([(0,c.Cb)()],V.prototype,"hasEffects",null),(0,d._)([(0,c.Cb)()],V.prototype,"includedEffects",null),(0,d._)([(0,c.Cb)({value:0})],V.prototype,"scale",null),(0,d._)([(0,c.Cb)()],V.prototype,"transitioning",null),V=(0,d._)([(0,w.j)("esri.layers.effects.FeatureEffectView")],V);const P=V;var N=a(98624),k=a(72469),Y=a(68653),ce=a(17253),Ze=a(65234);let re=class extends ce.Z{constructor(){super(...arguments),this.features=[]}readFeatures(t,e){const r=Ze.Z.fromJSON(e.spatialReference),i=[];for(let s=0;s<t.length;s++){const n=t[s],o=E.fromJSON(n),_=n.geometry?.spatialReference;null==o.geometry||_||(o.geometry.spatialReference=r);const y=n.aggregateGeometries,g=o.aggregateGeometries;if(y&&null!=g)for(const v in g){const I=g[v],C=y[v]?.spatialReference;null==I||C||(I.spatialReference=r)}i.push(o)}return i}};(0,d._)([(0,c.Cb)({type:[E],json:{write:!0}})],re.prototype,"features",void 0),(0,d._)([(0,Y.r)("features")],re.prototype,"readFeatures",null),re=(0,d._)([(0,w.j)("esri.rest.support.AggregateFeatureSet")],re);const De=re;var ae=a(96854),ze=a(39351),qe=a(37384),ke=a(49391),ve=a(36859),je=a(71379);let X=class extends B.Z{constructor(t){super(t),this.tiles=new Map}destroy(){this.tiles.clear(),this.layer=this.layerView=this.tileInfoView=this.tiles=null}get updating(){return this.isUpdating()}acquireTile(t){const e=this.createTile(t);return e.once("isReady",()=>this.notifyChange("updating")),this.tiles.set(t.id,e),this.notifyChange("updating"),e}forceAttributeTextureUpload(){}forEachTile(t){this.tiles.forEach(t)}releaseTile(t){this.tiles.delete(t.key.id),this.notifyChange("updating"),this.disposeTile(t)}isUpdating(){let t=!0;this.tiles.forEach(r=>{t=t&&r.isReady});const e=!t;if((0,m.Z)("esri-2d-log-updating")){let r="";this.tiles.forEach(i=>{r+=`-> ${i.key.id}: isReady: ${i.isReady} status: ${i.updateStatus}\n`,t=t&&i.isReady}),console.log(`Updating BaseTileRenderer ${e}\n${r}`)}return e}setHighlight(){}invalidateLabels(){}requestUpdate(){this.layerView.requestUpdate()}};(0,d._)([(0,c.Cb)()],X.prototype,"layer",void 0),(0,d._)([(0,c.Cb)()],X.prototype,"layerView",void 0),(0,d._)([(0,c.Cb)()],X.prototype,"tileInfoView",void 0),(0,d._)([(0,c.Cb)()],X.prototype,"updating",null),X=(0,d._)([(0,w.j)("esri.views.2d.layers.features.tileRenderers.BaseTileRenderer")],X);const be=X;class Ne{constructor(){this.gradient=null,this.height=512,this.intensities=null,this.width=512}render(e){(0,ve.hy)(e,512,this.intensities,this.gradient,this.minDensity,this.maxDensity)}}let fe=class extends be{constructor(t){super(t),this._intensityInfo={minDensity:0,maxDensity:0},this.type="heatmap",this.featuresView={attributeView:{initialize:()=>{},requestUpdate:()=>{}},requestRender:()=>{}},this._container=new je.s(t.tileInfoView)}createTile(t){const e=this._container.createTile(t);return this.tileInfoView.getTileCoords(e.bitmap,t),e.bitmap.resolution=this.tileInfoView.getTileResolution(t),e}onConfigUpdate(){const t=this.layer.renderer;if("heatmap"===t.type){const{minDensity:e,maxDensity:r,colorStops:i}=t;this._intensityInfo.minDensity=e,this._intensityInfo.maxDensity=r,this._gradient=(0,ve.uI)(i),this.tiles.forEach(s=>{const n=s.bitmap.source;n&&(n.minDensity=e,n.maxDensity=r,n.gradient=this._gradient,s.bitmap.invalidateTexture(),s.bitmap.requestRender())})}}hitTest(){return Promise.resolve([])}install(t){t.addChild(this._container)}uninstall(t){this._container.removeAllChildren(),t.removeChild(this._container)}disposeTile(t){this._container.removeChild(t),t.destroy()}supportsRenderer(t){return t&&"heatmap"===t.type}onTileData(t){const e=this.tiles.get(t.tileKey);if(!e)return;const r=t.intensityInfo,{minDensity:i,maxDensity:s}=this._intensityInfo,n=e.bitmap.source||new Ne;n.intensities=r?.matrix||null,n.minDensity=i,n.maxDensity=s,n.gradient=this._gradient,e.bitmap.source=n,this._container.addChild(e),this._container.requestRender(),this.requestUpdate()}onTileError(t){console.error(t)}lockGPUUploads(){}unlockGPUUploads(){}fetchResource(t,e){return console.error(t),Promise.reject()}};fe=(0,d._)([(0,w.j)("esri.views.2d.layers.features.tileRenderers.HeatmapTileRenderer")],fe);var He=a(65401),xe=a(65389),Ge=a(12225),oe=a(39406),Re=a(87526),Qe=a(29443);const pe=4294967296;class le{constructor(e){this._savedCursor=null,this._savedOffset=null,this._head=e,this._cursor=e}static from(e){const r=ue.from(new Float32Array(e));return new le(r)}get id(){return this._cursor.id}get baseZoom(){return this._cursor.baseZoom}get anchorX(){return this._cursor.anchorX}get anchorY(){return this._cursor.anchorY}get directionX(){return this._cursor.directionX}get directionY(){return this._cursor.directionY}get size(){return this._cursor.size}get materialKey(){return this._cursor.materialKey}get boundsCount(){return this._cursor.boundsCount}computedMinZoom(){return this._cursor.computedMinZoom()}setComputedMinZoom(e){return this._cursor.setComputedMinZoom(e)}boundsComputedAnchorX(e){return this._cursor.boundsComputedAnchorX(e)}boundsComputedAnchorY(e){return this._cursor.boundsComputedAnchorY(e)}setBoundsComputedAnchorX(e,r){return this._cursor.setBoundsComputedAnchorX(e,r)}setBoundsComputedAnchorY(e,r){return this._cursor.setBoundsComputedAnchorY(e,r)}boundsX(e){return this._cursor.boundsX(e)}boundsY(e){return this._cursor.boundsY(e)}boundsWidth(e){return this._cursor.boundsWidth(e)}boundsHeight(e){return this._cursor.boundsHeight(e)}link(e){if(null!=e._head)return this._cursor.link(e._head)}getCursor(){return this.copy()}copy(){const e=new le(this._head?.copy());if(!e._head)return e;let r=e._head,i=e._head._link;for(;i;)r._link=i.copy(),r=i,i=r._link;return e}peekId(){return this._cursor.peekId()??this._cursor._link.peekId()}nextId(){const e=this.id;for(;e===this.id;)if(!this.next())return!1;return!0}save(){this._savedCursor=this._cursor,this._savedOffset=this._cursor._offset}restore(){this._savedCursor&&(this._cursor=this._savedCursor),null!=this._savedOffset&&(this._cursor._offset=this._savedOffset)}next(){if(!this._cursor)return!1;if(!this._cursor.next()){if(!this._cursor._link)return!1;this._cursor=this._cursor._link,this._cursor._offset=0}return!0}lookup(e){for(this._cursor=this._head;this._cursor&&!this._cursor.lookup(e);){if(!this._cursor._link)return!1;this._cursor=this._cursor._link}return!!this._cursor}delete(e){let r=this._head,i=null;for(;r;){if(r.delete(e))return r.isEmpty()&&null!=i&&(i._link=r._link),!0;i=r,r=r._link}return!1}}class ue{constructor(e){this._offset=-1,this._link=null,this._count=0,this._deletedCount=0,this._offsets={instance:null},this._buffer=e}static from(e){return new ue(new Float32Array(e))}isEmpty(){return this._deletedCount===this.count}get count(){return this._count||(this._count=this._computeCount()),this._count}get id(){return this._buffer[this._offset]}set id(e){this._buffer[this._offset]=e}get baseZoom(){return this._buffer[this._offset+1]}get anchorX(){return this._buffer[this._offset+2]}get anchorY(){return this._buffer[this._offset+3]}get directionX(){return this._buffer[this._offset+4]}get directionY(){return this._buffer[this._offset+5]}get size(){return this._buffer[this._offset+6]}get materialKey(){return this._buffer[this._offset+7]}computedMinZoom(){return this._buffer[this._offset+8]}setComputedMinZoom(e){this._buffer[this._offset+8]=e}get boundsCount(){return this._buffer[this._offset+9]}boundsComputedAnchorX(e){return this._buffer[this._offset+10+6*e]}boundsComputedAnchorY(e){return this._buffer[this._offset+10+6*e+1]}setBoundsComputedAnchorX(e,r){this._buffer[this._offset+10+6*e]=r}setBoundsComputedAnchorY(e,r){this._buffer[this._offset+10+6*e+1]=r}boundsX(e){return this._buffer[this._offset+10+6*e+2]}boundsY(e){return this._buffer[this._offset+10+6*e+3]}boundsWidth(e){return this._buffer[this._offset+10+6*e+4]}boundsHeight(e){return this._buffer[this._offset+10+6*e+5]}link(e){let r=this;for(;r._link;)r=r._link;r._link=e}getCursor(){return this.copy()}copy(){const e=new ue(this._buffer);return e._link=this._link,e._offset=this._offset,e._deletedCount=this._deletedCount,e._offsets=this._offsets,e._count=this._count,e}peekId(){const e=this._offset+10+6*this.boundsCount+0;return e>=this._buffer.length?0:this._buffer[e]}next(){let e=0;for(;this._offset<this._buffer.length&&e++<100&&(-1===this._offset?this._offset=0:this._offset+=10+6*this.boundsCount,this.id===pe););return this.id!==pe&&this._offset<this._buffer.length}delete(e){const r=this._offset,i=this.lookup(e);if(i)for(this.id=4294967295,++this._deletedCount;this.next()&&this.id===e;)this.id=4294967295,++this._deletedCount;return this._offset=r,i}lookup(e){const r=this._offset;if(null==this._offsets.instance){this._offsets.instance=new Map;const i=this.copy();i._offset=-1;let s=0;for(;i.next();)i.id!==s&&(this._offsets.instance.set(i.id,i._offset),s=i.id)}return!!this._offsets.instance.has(e)&&(this._offset=this._offsets.instance.get(e),this.id!==pe||(this._offset=r,!1))}_computeCount(){const e=this._offset;let r=0;for(this._offset=-1;this.next();)r++;return this._offset=e,r}}var $e=a(50465),We=a(2172),Ke=a(31823),ye=a(83994),Ee=a(67969);class Ce{constructor(e,r,i,s){const n=We.g.create(r*i*Uint32Array.BYTES_PER_ELEMENT,s);this.size=r,this.strideInt=i,this.bufferType=e,this.dirty={start:1/0,end:0},this._gpu=null,this._cpu=n,this.clear()}get elementSize(){return this._cpu.length/this.strideInt}get invalidated(){return this.bufferSize>0&&!this._gpu}get invalidatedComputeBuffer(){return this.bufferSize>0&&!this._gpuComputeTriangles}invalidate(){this._invalidateTriangleBuffer(),this._gpu?.dispose(),this._gpu=null}_invalidateTriangleBuffer(){this._gpuComputeTriangles?.dispose(),this._gpuComputeTriangles=null}destroy(){this._gpu?.dispose(),this._gpuComputeTriangles?.dispose(),this._cpu?.destroy(),this._cpu2?.destroy()}clear(){this.dirty.start=1/0,this.dirty.end=0,this.freeList=new Ke.m({start:0,end:this._cpu.length/this.strideInt}),this.fillPointer=0}ensure(e){if(!(this.maxAvailableSpace()>=e)&&e*this.strideInt>this._cpu.length-this.fillPointer){this.invalidate();const r=this._cpu.length/this.strideInt,i=Math.round(1.25*(r+e));this._cpu.expand(i*this.strideInt*Uint32Array.BYTES_PER_ELEMENT),this.freeList.free(r,i-r)}}set(e,r){this._cpu.array[e]!==r&&(this._cpu.array[e]=r,this.dirty.start=Math.min(e,this.dirty.start),this.dirty.end=Math.max(e,this.dirty.end))}getGPUBuffer(e,r=!1){if(!this.bufferSize)return null;if(r){if("index"!==this.bufferType)throw new Error("Tired to get triangle buffer, but target is not an index buffer");return null==this._gpuComputeTriangles&&(this._gpuComputeTriangles=this._createComputeBuffer(e)),this._gpuComputeTriangles}return null==this._gpu&&(this._gpu=this._createBuffer(e)),this._gpu}getCPUBuffer(){if(!this._cpu2){const e=this._cpu.slice();this._cpu2=e}return this._cpu2.length!==this._cpu.length&&this._cpu2.expand(this._cpu.length*this._cpu.array.BYTES_PER_ELEMENT),this._cpu2.set(this._cpu),this._cpu2}get bufferSize(){return this._cpu.length/this.strideInt}maxAvailableSpace(){return this.freeList.maxAvailableSpace()}insert(e,r,i,s){const n=i*this.strideInt;if(!n)return 0;const o=r*this.strideInt*Uint32Array.BYTES_PER_ELEMENT,_=new Uint32Array(e,o,n),y=this.freeList.firstFit(i);(0,l.O3)(y,"First fit region must be defined");const g=y*this.strideInt,v=n,I=g/this.strideInt-r;if(0!==s)for(let S=0;S<_.length;S++)_[S]+=s;return this._cpu.array.set(_,g),this.dirty.start=Math.min(this.dirty.start,g),this.dirty.end=Math.max(this.dirty.end,g+v),this.fillPointer=Math.max(this.fillPointer,g+v),I}free(e,r,i){const s=e*this.strideInt,n=(e+r)*this.strideInt;if(!0===i)for(let o=e;o!==e+r;o++)this._cpu.array[o*this.strideInt]=2147450879;this.dirty.start=Math.min(this.dirty.start,s),this.dirty.end=Math.max(this.dirty.end,n),this.freeList.free(e,r)}upload(){if(this.dirty.end){if(this._invalidateTriangleBuffer(),null==this._gpu)return this.dirty.start=1/0,void(this.dirty.end=0);this._gpu.setSubData(this._cpu.array,this.dirty.start,this.dirty.start,this.dirty.end),this.dirty.start=1/0,this.dirty.end=0}}_createBuffer(e){const r=Ee.l1.DYNAMIC_DRAW;return"index"===this.bufferType?ye.f.createIndex(e,r,this._cpu.array):ye.f.createVertex(e,r,this._cpu.array)}_createComputeBuffer(e){const r=Ee.l1.DYNAMIC_DRAW,i=new Uint32Array(this.fillPointer/3);for(let s=0;s<this.fillPointer;s+=3)i[s/3]=this._cpu.array[s];return ye.f.createIndex(e,r,i)}}var we=a(37633),Xe=a(49353);class rt{constructor(e,r){this._vaos=new Map,this._indicesInvalid=!1,this.geometryType=e,this._stage=r}destroy(){for(const[e,r]of this._vaos)r?.disposeVAOOnly();this._indexBuffer=(0,l.SC)(this._indexBuffer),this._vertexBuffer=(0,l.SC)(this._vertexBuffer)}get records(){return this._records}insert(e,r,i){if(!e.records.byteLength)return;const s=e.stride;if(this._vertexBuffer&&this._indexBuffer){const o=e.vertices.byteLength/s;this._indexBuffer.ensure(e.indices.byteLength/4),this._vertexBuffer.ensure(o);const{vertices:_,indices:y}=e,g=we.$.from(e.records),v=this._vertexBuffer.insert(_,0,_.byteLength/s,0),I=this._indexBuffer.insert(y,0,y.byteLength/4,v);if(g.forEach(S=>{S.indexFrom+=I,S.vertexFrom+=v}),this._records.link(g),r)this._indicesInvalid=!0;else if(this._displayList){const S=g.getCursor();for(;S.next();)this._displayList.addRecord(S)}}else{const n=e.indices.byteLength/4,o=e.vertices.byteLength/s,_=s/Uint32Array.BYTES_PER_ELEMENT,y=this._stage.bufferPool;this._records=we.$.from(e.records),this._indexBuffer=new Ce("index",n,1,y),this._vertexBuffer=new Ce("vertex",o,_,y),this._indexBuffer.insert(e.indices,0,e.indices.byteLength/4,0),this._vertexBuffer.insert(e.vertices,0,e.vertices.byteLength/s,0),r&&(this._indicesInvalid=!0)}}remove(e){if(null!=this._records)for(const r of e){const i=this._records.getCursor();if(!i.lookup(r))continue;const s=i.indexFrom,n=i.vertexFrom;let o=i.indexCount,_=i.vertexCount;for(;i.next()&&i.id===r;)o+=i.indexCount,_+=i.vertexCount;this._indexBuffer.free(s,o),this._vertexBuffer.free(n,_,!0),this._records.delete(r)}}getVAO(e,r,i,s){if(!this._vertexBuffer||!this._indexBuffer||null==this._records||!this._vertexBuffer.bufferSize)return null;const n=s?1:0;let o=this._vaos.get(n);(this._vertexBuffer.invalidated||this._indexBuffer.invalidated||s&&this._indexBuffer.invalidatedComputeBuffer)&&(o?.disposeVAOOnly(),o=null),this._vertexBuffer.upload(),this._indexBuffer.upload();const _=this._indexBuffer.getGPUBuffer(e,1===n),y=this._vertexBuffer.getGPUBuffer(e);return o||(o=new Xe.U(e,i,r,{geometry:y},_),this._vaos.set(n,o)),o}forEachCommand(e){if(null!=this._records){if(this._sortIndices(this._records),!this._displayList){const r=this._cursorIndexOrder;this._displayList=$e.S.from(this,this.geometryType,this._records.getCursor(),r)}this._displayList.forEach(e)}}_sortIndices(e){const r=!!this._indexBuffer.bufferSize;if(!this._indicesInvalid)return;this._indicesInvalid=!1;let i=0;const s=e.getCursor(),n=[],o=[],_=[];for(;s.next();)o.push(s.index),_.push(s.sortKey),n.push(s.id);o.sort((v,I)=>{const S=_[I],C=_[v];return C===S?n[I]-n[v]:S-C});const y=e.getCursor(),g=r?this._indexBuffer.getCPUBuffer():this._vertexBuffer.getCPUBuffer();for(const v of o){if(!y.seekIndex(v))throw new Error("Expected to find index");if(r){const{indexFrom:I,indexCount:S}=y;y.indexFrom=i;for(let C=0;C<S;C++)this._indexBuffer.set(i++,g.array[I+C])}else{const{vertexFrom:I,vertexCount:S}=y,C=this._vertexBuffer.strideInt,j=I*C,G=j+S*C;y.vertexFrom=i/C;for(let ee=j;ee<G;ee++)this._vertexBuffer.set(i++,g.array[ee])}}this._cursorIndexOrder=o,this._displayList=null}}let nt=0;class at extends Qe.o{constructor(e,r,i,s,n,o){super(e,r,i,s),this.instanceId=nt++,this.patchCount=0,this._renderState={current:{geometry:new Map,metrics:null},next:null,swap:!1,swapFrames:0,locked:!1},this._patches=new xe.Z(100),this._bufferPatches=new xe.Z(100),this._lastCommitTime=0,this.transforms.labelMat2d=(0,Ge.c)(),this._store=n,this._requestLabelUpdate=o}destroy(){super.destroy(),this._renderState.current.geometry.forEach(e=>e.destroy()),null!=this._renderState.next&&this._renderState.next.geometry.forEach(e=>e.destroy()),this._renderState.current=null,this._renderState.next=null}get labelMetrics(){return this._renderState.current.metrics}get hasData(){return!!this._renderState.current.geometry.size}get updateStatus(){return`renderState:${!!this._renderState.current}, ${!!this._renderState.next}, hasData:${this.hasData}, queue:${this._patches.size}`}getGeometry(e){return this._renderState.current.geometry.get(e)}patch(e,r){this.patchCount++,e.clear&&this._patches.size>=50&&this._dropPatches();const i=e;r&&i.addOrUpdate&&this.key.id!==i.addOrUpdate.tileKeyOrigin?this._bufferPatches.enqueue(i):(i.sort=i.sort&&!r,this._patches.enqueue(i)),this.requestRender()}commit(e){if(this._lastCommitTime!==e.time){this._lastCommitTime=e.time;for(let r=0;r<4;r++)this._updateMesh(),this.isReady&&this._updateBufferMesh();this._renderState.swap&&(this._swapRenderStates(),this.requestRender())}}lock(){this._renderState.locked=!0}unlock(){this._renderState.locked=!1,this._flushUpdates(),this._swap()}_swapRenderStates(){if(this._renderState.next){if(this._renderState.locked)return this._renderState.swap=!0,void this.requestRender();this._renderState.swap=!0,this._swap()}}_swap(){this._renderState.swap&&(this._renderState.swap=!1,null!=this._renderState.next&&(this._renderState.current.geometry.forEach(e=>e.destroy()),this._renderState.current=this._renderState.next,this._renderState.next=null,this._requestLabelUpdate()))}_flushUpdates(){let e=this._patches.maxSize;for(;this._patches.size&&e--;)this._updateMesh(),this._swap()}_updateBufferMesh(){const e=this._bufferPatches.peek();if(null==e||!e.clear||null===this._renderState.next)for(;this._bufferPatches.size;){const r=this._bufferPatches.dequeue();null!=r&&this._patchBuffer(r)}}_updateMesh(){const e=this._patches.dequeue();if(null!=e){if((0,m.Z)("esri-2d-update-debug")){const r=e,i=r.addOrUpdate?.tileKeyOrigin,s=this.key.id===i?"SELF":i;let n="";for(let o=0;o<5;o++)n+=r.addOrUpdate?.data[o]?.records?.byteLength?1:0;console.debug(this.key.id,"FeatureTile:patch",`[clear: ${r.clear} origin: ${s}, end:${r.end} data:${n}]`)}!0===e.clear&&(null!=this._renderState.next&&(this._renderState.next.geometry.forEach(r=>r.destroy()),this._renderState.next=null),this._renderState.next={geometry:new Map,metrics:null},(0,m.Z)("esri-2d-update-debug")&&console.debug(this.key.id,"FeatureTile:_updateMesh - Creating new renderState")),this.requestRender(),this._patch(e),e.end&&((0,m.Z)("esri-2d-update-debug")&&console.debug(this.key.id,"FeatureTile:_updateMesh - Encountered end message"),this.ready(),this._swapRenderStates())}}_patch(e){(0,Re.Z_)(r=>{this._remove(r,e.remove),this._insert(r,e,!1)})}_patchBuffer(e){(0,Re.Z_)(r=>{this._insert(r,e,!0)})}_insert(e,r,i){try{const n=r.addOrUpdate?.data[e],o=(this._renderState.next??this._renderState.current).geometry;if(null==n)return;o.has(e)||((0,m.Z)("esri-2d-update-debug")&&console.debug(this.key.id,`FeatureTile:_insert - Creating geometry buffer ${e}`),o.set(e,new rt(e,this.stage))),(0,m.Z)("esri-2d-update-debug")&&console.debug(this.key.id,`FeatureTile:_insert - Inserting into ${e}, version=${r.addOrUpdate?.version} stride=${n.stride}`),o.get(e).insert(n,r.sort,i),e===oe.LW.LABEL&&this._insertLabelMetrics(r.type,n.metrics,r.clear)}catch{}}_insertLabelMetrics(e,r,i){const s=this._renderState.next??this._renderState.current;if(null==r)return;const n=le.from(r);if(null!=s.metrics){if("update"===e){const o=n.getCursor();for(;o.next();)s.metrics.delete(o.id)}s.metrics.link(n)}else s.metrics=n}_remove(e,r){const i=(this._renderState.next??this._renderState.current).geometry.get(e);r&&r.length&&i&&(i.remove(r),this._removeLabelMetrics(r))}_removeLabelMetrics(e){const{metrics:r}=this._renderState.next??this._renderState.current;if(null!=r&&e.length)for(const i of e)for(;r.delete(i););}_dropPatches(){const e=new Array;let r=!1;for(;this._patches.size;){const i=this._patches.dequeue();if(null==i)break;if(i.clear){if(r)break;r=!0}e.push(i)}this._patches.clear(),e.forEach(i=>this._patches.enqueue(i))}}var Ie=a(22418),ot=a(6257),Z=a(93548),lt=a(47123);const ut=(0,m.Z)("featurelayer-order-by-server-enabled");class ht extends lt.T{constructor(e,r,i,s){super(e),this._hitTestsRequests=[],this._layer=i,this._layerView=r,this._onUpdate=s}renderChildren(e){this.attributeView.update(),this.hasAnimation&&e.painter.effects.integrate.draw(e,e.attributeView),super.renderChildren(e)}hasEmptyAttributeView(){return this.attributeView.isEmpty()}isUpdating(){return this.attributeView.isUpdating()}hitTest(e){let r=this._hitTestsRequests.find(({x:s,y:n})=>s===e.x&&n===e.y);const i=(0,h.hh)();return r?r.resolvers.push(i):(r={x:e.x,y:e.y,resolvers:[i]},this._hitTestsRequests.push(r)),this.requestRender(),i.promise}onTileData(e,r){const i=ut&&"orderBy"in this._layer&&this._layer.orderBy;e.patch(r,!!i&&this._layerView.orderByFields===(i&&i?.length&&!i[0].valueExpression&&i[0].field)),this.contains(e)||this.addChild(e),this.requestRender()}onTileError(e){this.contains(e)||this.addChild(e)}updateTransitionProperties(e,r){super.updateTransitionProperties(e,r),this._layerView.featureEffectView.transitionStep(e,r),this._layerView.featureEffectView.transitioning&&this.requestRender()}doRender(e){const{minScale:r,maxScale:i}=this._layer.effectiveScaleRange,s=e.state.scale;s<=(r||1/0)&&s>=i&&super.doRender(e)}afterRender(e){super.afterRender(e),this._hitTestsRequests.length&&this.requestRender()}onAttributeStoreUpdate(){this.hasLabels&&this._layerView.view.labelManager.requestUpdate(),this._onUpdate()}get hasAnimation(){return this.hasLabels}setStencilReference(e){const{rendererSchema:r}=e.rendererInfo;if("dot-density"===r?.type&&r?.dotSize>1||"heatmap"===r?.type)for(const s of this.children)s.stencilRef=s.key.level+1;else super.setStencilReference(e)}get hasHighlight(){return this._layerView.hasHighlight()}get hasLabels(){if("sublayers"in this._layer)return this._layer.sublayers.some(i=>!!i.labelingInfo?.length&&i.labelsVisible);const e=this._layer.featureReduction;return this._layer.labelingInfo?.length&&this._layer.labelsVisible||!!(e&&"labelingInfo"in e&&e.labelsVisible&&e.labelingInfo&&e.labelingInfo.length)}prepareRenderPasses(e){const r=super.prepareRenderPasses(e),i=e.registerRenderPass({name:"label",brushes:[Z.U.label],target:()=>this.hasLabels?this.children:null,drawPhase:oe.jx.LABEL|oe.jx.LABEL_ALPHA});if((0,m.Z)("featurelayer-force-marker-text-draw-order")){const n=e.registerRenderPass({name:"geometry",brushes:[Z.U.fill,Z.U.dotDensity,Z.U.line,Z.U.heatmap,Z.U.pieChart],target:()=>this.children,forceDrawByDisplayOrder:!0,enableDefaultDraw:()=>!this._layerView.featureEffectView.hasEffects,effects:[{apply:e.effects.outsideEffect,enable:()=>this._layerView.featureEffectView.hasEffects,args:()=>this._layerView.featureEffectView.excludedEffects},{apply:e.effects.insideEffect,enable:()=>this._layerView.featureEffectView.hasEffects,args:()=>this._layerView.featureEffectView.includedEffects},{apply:e.effects.hittest,enable:()=>!!this._hitTestsRequests.length,args:()=>this._hitTestsRequests}]});r.push(n)}else{const n=e.registerRenderPass({name:"geometry",brushes:[Z.U.fill,Z.U.dotDensity,Z.U.line,Z.U.marker,Z.U.heatmap,Z.U.pieChart,Z.U.text],target:()=>this.children,enableDefaultDraw:()=>!this._layerView.featureEffectView.hasEffects,effects:[{apply:e.effects.outsideEffect,enable:()=>this._layerView.featureEffectView.hasEffects,args:()=>this._layerView.featureEffectView.excludedEffects},{apply:e.effects.insideEffect,enable:()=>this._layerView.featureEffectView.hasEffects,args:()=>this._layerView.featureEffectView.includedEffects},{apply:e.effects.hittest,enable:()=>!!this._hitTestsRequests.length,args:()=>this._hitTestsRequests}]});r.push(n)}const s=e.registerRenderPass({name:"highlight",brushes:[Z.U.fill,Z.U.dotDensity,Z.U.line,Z.U.marker,Z.U.pieChart,Z.U.text],target:()=>this.children,drawPhase:oe.jx.HIGHLIGHT,enableDefaultDraw:()=>!1,effects:[{apply:e.effects.highlight,enable:()=>!!this._layerView.hasHighlight()}]});return r.push(s),r.push(i),r}}let _e=class extends be{constructor(){super(...arguments),this.type="symbol"}install(t){const r=new ht(this.tileInfoView,this.layerView,this.layer,()=>this.notifyChange("updating"));this.featuresView=r,t.addChild(r)}uninstall(t){t.removeChild(this.featuresView),this.featuresView=(0,l.SC)(this.featuresView)}fetchResource(t,e){const{url:r}=t,i=this.featuresView.stage;try{return i.resourceManager.fetchResource(r,{signal:e.signal})}catch(s){return(0,h.D_)(s)?Promise.resolve({width:0,height:0}):Promise.reject(s)}}isUpdating(){const t=super.isUpdating(),e=!this.featuresView||this.featuresView.isUpdating(),r=this.featuresView?.hasEmptyAttributeView(),i=t||e||t&&r;return(0,m.Z)("esri-2d-log-updating")&&console.log(`Updating SymbolTileRenderer ${i}\n  -> updatingTiles ${t}\n  -> hasFeaturesView ${!!this.featuresView}\n  -> updatingFeaturesView ${e}`),i}hitTest(t){return this.featuresView.hitTest(t)}supportsRenderer(t){return null!=t&&["simple","class-breaks","unique-value","dot-density","dictionary","heatmap","pie-chart"].includes(t.type)}onConfigUpdate(t){let e=null;if(t&&"visualVariables"in t){const r=((0,Ie.aR)(t).visualVariables||[]).map(i=>{const s=i.clone();return"normalizationField"in i&&(s.normalizationField=null),i.valueExpression&&"$view.scale"!==i.valueExpression&&(s.valueExpression=null,s.field="nop"),s});e=(0,ot.I)(r)}this.featuresView.setRendererInfo(t,e,this.layerView.featureEffect)}onTileData(t){const e=this.tiles.get(t.tileKey);e&&t.data&&this.featuresView.onTileData(e,t.data),this.layerView.view.labelManager.requestUpdate()}onTileError(t){const e=this.tiles.get(t.tileKey);e&&this.featuresView.onTileError(e)}forceAttributeTextureUpload(){this.featuresView.attributeView.forceTextureUpload()}lockGPUUploads(){this.featuresView.attributeView.lockTextureUpload(),this.tiles.forEach(t=>t.lock())}unlockGPUUploads(){this.featuresView.attributeView.unlockTextureUpload(),this.tiles.forEach(t=>t.unlock())}getMaterialItems(t){var e=this;return(0,u.Z)(function*(){return e.featuresView.getMaterialItems(t)})()}invalidateLabels(){this.featuresView.hasLabels&&this.layerView.view.labelManager.requestUpdate()}createTile(t){const e=this.tileInfoView.getTileBounds((0,He.Ue)(),t),i=this.tileInfoView.getTileResolution(t.level);return new at(t,i,e[0],e[3],this.featuresView.attributeView,()=>this.layerView.view.labelManager.requestUpdate())}disposeTile(t){this.featuresView.removeChild(t),t.destroy(),this.layerView.view.labelManager.requestUpdate()}};_e=(0,d._)([(0,w.j)("esri.views.2d.layers.features.tileRenderers.SymbolTileRenderer")],_e);var ie=a(62192),ct=a(7875);function ge(t){return t.some(e=>e.globalId)}function se(t){return t.filter(e=>!e.error).map(e=>e.objectId??e.globalId).filter(e=>null!=e)}function Ue(t,e){const r=new Set(t);for(const i of e.values())r.add(i);return r}function Ve(t,e){const r=new Set(t);for(const i of e.values())r.delete(i);return r}let ne=class extends B.Z{constructor(t){super(t),this._hasGlobalIds=!1,this._notifyUpdating=()=>{this.notifyChange("updating")}}normalizeCtorArgs(t){return this._queueProcessor=new ct.e({concurrency:1,process:t.process}),{}}destroy(){this.clear()}get updating(){return this._queueProcessor.length>0}clear(){this._queueProcessor.clear()}push(t){const e=this._queueProcessor,r=e.last();switch(t.type){case"update":case"refresh":if(r?.type===t.type)return;e.push(t).then(this._notifyUpdating,this._notifyUpdating);break;case"edit":{const i="processed-edit"===r?.type?r:null;i&&e.popLast();const s=this._mergeEdits(i,t);for(const n of s)n&&e.push(n).then(this._notifyUpdating,this._notifyUpdating);break}}this.notifyChange("updating")}_mergeEdits(t,e){const{addedFeatures:r,deletedFeatures:i,updatedFeatures:s}=e.edits;if(this._hasGlobalIds=this._hasGlobalIds||ge(r)||ge(s)||ge(i),this._hasGlobalIds)return[t,{type:"processed-edit",edits:{addOrModified:[...r,...s],removed:i}}];const n=new Set(se(t?.edits.addOrModified??[])),o=new Set(se(t?.edits.removed??[])),_=new Set([...se(r),...se(s)]),y=new Set(se(i));return[{type:"processed-edit",edits:{addOrModified:Array.from(Ue(Ve(n,y),_)).map(g=>({objectId:g})),removed:Array.from(Ue(Ve(o,_),y)).map(g=>({objectId:g}))}}]}};(0,d._)([(0,c.Cb)({readOnly:!0})],ne.prototype,"updating",null),(0,d._)([(0,c.Cb)()],ne.prototype,"process",void 0),ne=(0,d._)([(0,w.j)("esri.views.2d.layers.support.FeatureCommandQueue")],ne);const ft=ne;var pt=a(60330),yt=a(97347);let te=class extends pt.D{constructor(t){super(t),this._startupResolver=(0,h.hh)(),this.isReady=!1}initialize(){this._controller=new AbortController,this.addResolvingPromise(this._startWorker(this._controller.signal))}destroy(){this._controller.abort(),this._connection&&this._connection.close()}set tileRenderer(t){this.client.tileRenderer=t}get closed(){return this._connection.closed}startup(t,e,r,i){var s=this;return(0,u.Z)(function*(){yield s.when();const n=s._controller.signal,o=function _t(t){return Array.isArray(t)}(r.source)?{transferList:r.source,signal:n}:void 0,_={service:r,config:e,tileInfo:t.tileInfo.toJSON(),tiles:i};yield s._connection.invoke("startup",_,o),s._startupResolver.resolve(),s._set("isReady",!0)})()}updateTiles(t){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,(0,h.R8)(e._connection.invoke("updateTiles",t))})()}update(t){var e=this;return(0,u.Z)(function*(){const r={config:t};return yield e._startupResolver.promise,e._connection.invoke("update",r)})()}applyUpdate(t){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("applyUpdate",t)})()}setHighlight(t){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,(0,h.R8)(e._connection.invoke("controller.setHighlight",t))})()}stop(){var t=this;return(0,u.Z)(function*(){if(yield t._startupResolver.promise,!t.closed)return(0,h.R8)(t._connection.invoke("stop"))})()}refresh(t){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,(0,h.R8)(e._connection.invoke("controller.refresh",t))})()}querySummaryStatistics(t,e,r){var i=this;return(0,u.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.querySummaryStatistics",{query:t.toJSON(),params:e},r)})()}queryAggregateSummaryStatistics(t,e,r){var i=this;return(0,u.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryAggregateSummaryStatistics",{query:t.toJSON(),params:e},r)})()}queryUniqueValues(t,e,r){var i=this;return(0,u.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryUniqueValues",{query:t.toJSON(),params:e},r)})()}queryAggregateUniqueValues(t,e,r){var i=this;return(0,u.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryAggregateUniqueValues",{query:t.toJSON(),params:e},r)})()}queryClassBreaks(t,e,r){var i=this;return(0,u.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryClassBreaks",{query:t.toJSON(),params:e},r)})()}queryAggregateClassBreaks(t,e,r){var i=this;return(0,u.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryAggregateClassBreaks",{query:t.toJSON(),params:e},r)})()}queryHistogram(t,e,r){var i=this;return(0,u.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryHistogram",{query:t.toJSON(),params:e},r)})()}queryAggregateHistogram(t,e,r){var i=this;return(0,u.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryAggregateHistogram",{query:t.toJSON(),params:e},r)})()}queryFeatures(t,e){var r=this;return(0,u.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryFeatures",t?.toJSON(),e)})()}queryVisibleFeatures(t,e){var r=this;return(0,u.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryVisibleFeatures",t?.toJSON(),e)})()}queryObjectIds(t,e){var r=this;return(0,u.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryObjectIds",t?.toJSON(),e)})()}queryFeatureCount(t,e){var r=this;return(0,u.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryFeatureCount",t?.toJSON(),e)})()}queryExtent(t,e){var r=this;return(0,u.Z)(function*(){return r._connection.invoke("controller.queryExtent",t.toJSON(),e)})()}queryLatestObservations(t,e){var r=this;return(0,u.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryLatestObservations",t.toJSON(),e)})()}queryStatistics(t){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("controller.queryStatistics",t)})()}queryAggregates(t,e){var r=this;return(0,u.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryAggregates",t?.toJSON(),e)})()}queryAggregateCount(t,e){var r=this;return(0,u.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryAggregateCount",t?.toJSON(),e)})()}queryAggregateIds(t,e){var r=this;return(0,u.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryAggregateIds",t?.toJSON(),e)})()}getObjectId(t){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("controller.getObjectId",t)})()}getDisplayId(t){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("controller.getDisplayId",t)})()}getFeatures(t){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("controller.getFeatures",t)})()}getAggregates(){var t=this;return(0,u.Z)(function*(){return yield t._startupResolver.promise,t._connection.invoke("controller.getAggregates")})()}getAggregateValueRanges(){var t=this;return(0,u.Z)(function*(){return yield t._startupResolver.promise,t._connection.invoke("controller.getAggregateValueRanges")})()}mapValidDisplayIds(t){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("controller.mapValidDisplayIds",t)})()}onEdits(t){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,(0,h.R8)(e._connection.invoke("controller.onEdits",t))})()}enableEvent(t,e){var r=this;return(0,u.Z)(function*(){return yield r._startupResolver.promise,(0,h.R8)(r._connection.invoke("controller.enableEvent",{name:t,value:e}))})()}pauseStream(){var t=this;return(0,u.Z)(function*(){return yield t._startupResolver.promise,(0,h.R8)(t._connection.invoke("controller.pauseStream"))})()}resumeStream(){var t=this;return(0,u.Z)(function*(){return yield t._startupResolver.promise,(0,h.R8)(t._connection.invoke("controller.resumeStream"))})()}sendMessageToSocket(t){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,(0,h.R8)(e._connection.invoke("controller.sendMessageToSocket",t))})()}sendMessageToClient(t){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,(0,h.R8)(e._connection.invoke("controller.sendMessageToClient",t))})()}updateCustomParameters(t){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,(0,h.R8)(e._connection.invoke("controller.updateCustomParameters",t))})()}_startWorker(t){var e=this;return(0,u.Z)(function*(){try{e._connection=yield(0,yt.bA)("Pipeline",{client:e.client,strategy:"dedicated",signal:t})}catch(r){(0,h.H9)(r)}})()}};(0,d._)([(0,c.Cb)()],te.prototype,"isReady",void 0),(0,d._)([(0,c.Cb)({constructOnly:!0})],te.prototype,"client",void 0),(0,d._)([(0,c.Cb)()],te.prototype,"tileRenderer",null),te=(0,d._)([(0,w.j)("esri.views.2d.layers.support.FeatureLayerProxy")],te);const gt=te;var Fe=a(21286),mt=a(21254),J=a(86971);const vt=Math.PI;function Pe(t,e){switch(e.transformationType){case J.hL.Additive:return function bt(t,e){return t+(Q(e.minSize,t)||e.minDataValue)}(t,e);case J.hL.Constant:return function xt(t,e){const r=t.stops;let i=r?.length&&r[0].size;return null==i&&(i=t.minSize),Q(i,e)}(e,t);case J.hL.ClampedLinear:return function Rt(t,e){const r=e.minDataValue,i=e.maxDataValue,s=(t-r)/(i-r),n=Q(e.minSize,t),o=Q(e.maxSize,t);return t<=r?n:t>=i?o:n+s*(o-n)}(t,e);case J.hL.Proportional:return function Et(t,e){const r=t/e.minDataValue,i=Q(e.minSize,t),s=Q(e.maxSize,t);let n=null;return n=r*i,(0,Fe.uZ)(n,i,s)}(t,e);case J.hL.Stops:return function St(t,e){const[r,i,s]=function wt(t,e){if(!e)return;let r=0,i=e.length-1;return e.some((s,n)=>t<s?(i=n,!0):(r=n,!1)),[r,i,(t-e[r])/(e[i]-e[r])]}(t,e.cache.ipData);if(r===i)return Q(e.stops[r].size,t);{const n=Q(e.stops[r].size,t);return n+(Q(e.stops[i].size,t)-n)*s}}(t,e);case J.hL.RealWorldSize:return function Ct(t,e){const r=mt.a[e.valueUnit],i=Q(e.minSize,t),s=Q(e.maxSize,t),{valueRepresentation:n}=e;let o=null;return o="area"===n?2*Math.sqrt(t/vt)/r:"radius"===n||"distance"===n?2*t/r:t/r,(0,Fe.uZ)(o,i,s)}(t,e);case J.hL.Identity:return t;case J.hL.Unknown:return null}}function Q(t,e){return"number"==typeof t?t:Pe(e,t)}var Tt=a(84378),Ae=a(58098);class Ut{constructor(e){this._tiles=new Map,this.buffer=0,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,this.buffer=e.buffer}destroy(){}clear(){this._tiles.forEach(e=>this._releaseTile(e))}tileKeys(){const e=[];return this._tiles.forEach((r,i)=>e.push(i)),e}update(e){const r=this.tileInfoView.getTileCoverage(e.state,this.buffer,!0,"closest"),{spans:i,lodInfo:s}=r,{level:n}=s,o=[],_=[],y=new Set,g=new Set;for(const{row:v,colFrom:I,colTo:S}of i)for(let C=I;C<=S;C++){const j=Ae.Z.getId(n,v,s.normalizeCol(C),s.getWorldForColumn(C)),G=this._getOrAcquireTile(o,j);y.add(j),G.isReady?G.visible=!0:g.add(G.key)}return g.forEach(v=>this._addPlaceholders(y,v)),this._tiles.forEach(v=>{y.has(v.key.id)||(_.push(v.key.id),this._releaseTile(v))}),Tt.Z.pool.release(r),{hasMissingTiles:g.size>0,added:o,removed:_}}_getOrAcquireTile(e,r){if(!this._tiles.has(r)){const i=this.acquireTile(new Ae.Z(r));e.push(r),this._tiles.set(r,i),i.visible=!1}return this._tiles.get(r)}_getTile(e){return this._tiles.get(e)}_releaseTile(e){this._tiles.delete(e.key.id),this.releaseTile(e)}_addPlaceholders(e,r){const i=this._addPlaceholderChildren(e,r);Math.abs(1-i)<1e-6||this._addPlaceholderParent(e,r)||(this._getTile(r.id).visible=!0)}_addPlaceholderChildren(e,r){let i=0;return this._tiles.forEach(s=>{i+=this._addPlaceholderChild(e,s,r)}),i}_addPlaceholderChild(e,r,i){return r.key.level<=i.level||!r.hasData||!i.contains(r.key)?0:(r.visible=!0,e.add(r.key.id),1/(1<<2*(r.key.level-i.level)))}_addPlaceholderParent(e,r){let i=r.getParentKey(),s=0,n=null;for(;null!=i;){if(e.has(i.id))return!0;const o=this._getTile(i.id);if(o?.isReady){for(const _ of e){const y=this._getTile(_);y&&i.contains(y.key)&&(y.visible=!1)}return o.visible=!0,e.add(o.key.id),!0}o?.hasData&&o.patchCount>s&&(s=o.patchCount,n=o),i=i.getParentKey()}return!!n&&(n.visible=!0,e.add(n.key.id),!0)}}var Vt=a(13812),Ft=a(2319),D=a(90194),Oe=a(59990),Pt=a(46679),he=a(10023);const Be="esri.views.layers.FeatureLayerView",me=R.Z.getLogger(Be),At=t=>{let e=class extends t{constructor(...r){super(...r),this._updatingRequiredFieldsPromise=null,this.dataUpdating=!1,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){this.addHandles([(0,f.YP)(()=>{const r=this.layer;return[r?.elevationInfo?.featureExpressionInfo,r&&"displayField"in r?r.displayField:null,r&&"timeInfo"in r&&r.timeInfo,r&&"renderer"in r&&r.renderer,r&&"labelingInfo"in r&&r.labelingInfo,r&&"floorInfo"in r&&r.floorInfo,this.filter,this.featureEffect,this.timeExtent]},()=>this._handleRequiredFieldsChange(),f.tX),(0,f.on)(()=>this.view?.floors,"change",()=>this._handleRequiredFieldsChange()),(0,f.on)(()=>{const r=this.layer;return r&&"sublayers"in r?r.sublayers:null},"change",()=>this._handleRequiredFieldsChange())])}get availableFields(){const{layer:r,layer:{fieldsIndex:i},requiredFields:s}=this;return(0,D.Q0)(i,"outFields"in r&&r.outFields?[...(0,D.Lk)(i,r.outFields),...s]:s)}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(r){this._override("featureEffect",r)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(r){me.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(r){throw new Error("missing implementation")}createQuery(){const r={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},i=null!=this.filter?this.filter.createQuery(r):new ae.Z(r);if("feature"===this.layer.type){const s=(0,Oe.c)(this);null!=s&&(i.where=i.where?`(${i.where}) AND (${s})`:s)}return null!=this.timeExtent&&(i.timeExtent=null!=i.timeExtent?i.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),i}createAggregateQuery(){return new ae.Z({outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference})}queryFeatures(r,i){throw new Error("missing implementation")}queryObjectIds(r,i){throw new Error("missing implementation")}queryFeatureCount(r,i){throw new Error("missing implementation")}queryExtent(r,i){throw new Error("missing implementation")}fetchPopupFeatures(r,i){var s=this;return(0,u.Z)(function*(){const n=s.validateFetchPopupFeatures(i);if(n)throw n;return s.fetchClientPopupFeatures(i)})()}_loadArcadeModules(r){return r.expressionInfos?.length||Array.isArray(r.content)&&r.content.some(i=>"expression"===i.type)?(0,Pt.LC)():Promise.resolve()}_handleRequiredFieldsChange(){const r=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",r),r.then(()=>{this._updatingRequiredFieldsPromise===r&&this._set("_updatingRequiredFieldsPromise",null)})}_updateRequiredFields(){var r=this;return(0,u.Z)(function*(){if(!r.layer||!r.view)return;const i="3d"===r.view.type,{layer:s,layer:{fieldsIndex:n,objectIdField:o}}=r,_="renderer"in s&&s.renderer,y="orderBy"in s&&s.orderBy,g="featureReduction"in s?s.featureReduction:null,v=new Set,I=yield Promise.allSettled([_?_.collectRequiredFields(v,n):null,(0,D.Mu)(v,s),i?(0,D.vl)(v,s):null,null!=r.filter?(0,D.Ll)(v,s,r.filter):null,null!=r.featureEffect?(0,D.Ll)(v,s,r.featureEffect.filter):null,g?(0,D.ZV)(v,s,g):null,y?(0,D.Qj)(v,s,y):null]);if("timeInfo"in s&&s.timeInfo&&r.timeExtent&&(0,D.gd)(v,s.fieldsIndex,[s.timeInfo.startField,s.timeInfo.endField]),"feature"===s.type&&(s.floorInfo&&(0,D.gd)(v,s.fieldsIndex,[s.floorInfo.floorField]),i&&null!=s.infoFor3D&&(null==s.globalIdField&&me.error("globalIdField missing on 3DObjectFeatureLayer"),(0,D.gd)(v,s.fieldsIndex,[s.globalIdField]))),"subtype-group"===s.type){(0,D.AB)(v,n,s.subtypeField);const C=s.sublayers.map(j=>Promise.all([j.renderer?.collectRequiredFields(v,n),(0,D.Mu)(v,j)]));yield Promise.allSettled(C)}for(const C of I)"rejected"===C.status&&me.error(C.reason);(0,D.AB)(v,n,o),i&&"displayField"in s&&s.displayField&&(0,D.AB)(v,n,s.displayField);const S=Array.from(v).sort();r._set("requiredFields",S)})()}validateFetchPopupFeatures(r){if(null==r)return null;for(const i of r.clientGraphics??[]){const s=i.layer;if("popupEnabled"in s&&!s.popupEnabled)return new F.Z("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:s});if(i.isAggregate){const n="featureReduction"in s?s.featureReduction:null;if(!(n&&"popupTemplate"in n&&n.popupEnabled&&n.popupTemplate))return new F.Z("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:s})}else if("popupTemplate"in s&&!(0,he.V5)(s,r))return new F.Z("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:s})}}fetchClientPopupFeatures(r){var i=this;return(0,u.Z)(function*(){const s=null!=r?r.clientGraphics:null;if(!s||0===s.length)return[];const n=new Array(s.length),o=new Map,_=yield i.createPopupQuery(r);for(let y=0;y<s.length;y++){const g=s[y];if(g.isAggregate){n[y]=g;continue}const v=g.layer;if(!("popupEnabled"in v))continue;const I=(0,D.Lk)(i.layer.fieldsIndex,_.outFields),S=(0,he.V5)(v,r);if(null==S)continue;const C=yield i._loadArcadeModules(S);C&&C.arcadeUtils.hasGeometryOperations(S)||!(0,D.R9)(I,g)?o.set(g.getObjectId(),{graphic:g,index:y}):n[y]=g}if("stream"===i.layer.type||0===o.size)return n.filter(Boolean);_.objectIds=Array.from(o.keys());try{const y=yield i.layer.queryFeatures(_);for(const g of y.features){const{graphic:{geometry:v},index:I}=o.get(g.getObjectId());g.geometry||=v,n[I]=g}}catch{}return n.filter(Boolean)})()}createPopupQuery(r){var i=this;return(0,u.Z)(function*(){const s=i.layer.createQuery(),n=new Set;let o=!1;const _=r?.clientGraphics?r.clientGraphics.map(y=>y.layer):[i.layer];for(const y of _){if(!("popupEnabled"in y))continue;const g=(0,he.V5)(y,r);if(null==g)continue;const v=yield i._loadArcadeModules(g),I=v&&v.arcadeUtils.hasGeometryOperations(g);o=!("point"!==i.layer.geometryType&&!I);const S=yield(0,he.e7)(i.layer,g);for(const C of S)n.add(C)}if(s.returnGeometry=o,s.returnZ=o,s.returnM=o,s.outFields=Array.from(n),s.outSpatialReference=i.view.spatialReference,"feature"===i.layer.type){const y=(0,Oe.c)(i);null!=y&&(s.where=s.where?`(${s.where}) AND (${y})`:y)}return s})()}canResume(){return!(!super.canResume()||null!=this.timeExtent&&this.timeExtent.isEmpty)}};return(0,d._)([(0,c.Cb)()],e.prototype,"_updatingRequiredFieldsPromise",void 0),(0,d._)([(0,c.Cb)({readOnly:!0})],e.prototype,"availableFields",null),(0,d._)([(0,c.Cb)({readOnly:!0})],e.prototype,"dataUpdating",void 0),(0,d._)([(0,c.Cb)({type:Ft.Z})],e.prototype,"featureEffect",null),(0,d._)([(0,c.Cb)({type:N.Z})],e.prototype,"filter",void 0),(0,d._)([(0,c.Cb)(Vt.qG)],e.prototype,"timeExtent",void 0),(0,d._)([(0,c.Cb)()],e.prototype,"layer",void 0),(0,d._)([(0,c.Cb)({type:Number})],e.prototype,"maximumNumberOfFeatures",null),(0,d._)([(0,c.Cb)({readOnly:!0,type:Boolean})],e.prototype,"maximumNumberOfFeaturesExceeded",null),(0,d._)([(0,c.Cb)({readOnly:!0})],e.prototype,"requiredFields",void 0),(0,d._)([(0,c.Cb)()],e.prototype,"suspended",void 0),(0,d._)([(0,c.Cb)()],e.prototype,"view",void 0),e=(0,d._)([(0,w.j)(Be)],e),e};var Ot=a(45611),Bt=a(94421),Lt=a(31637),Mt=a(2004);function Le(t){return t&&"openPorts"in t}function Dt(t){return e=>(0,T.F2)(Pe(e,t))}const Me="esri.views.2d.layers.FeatureLayerView2D";let z=class extends(At((0,Bt.Z)((0,qe.y)(Ot.Z)))){constructor(){var t;super(...arguments),t=this,this._pipelineIsUpdating=!0,this._commandsQueue=new ft({process:e=>{switch(e.type){case"processed-edit":return this._doEdit(e);case"refresh":return this._doRefresh(e.dataChanged);case"update":return this._doUpdate()}}}),this._visibilityOverrides=new Set,this._highlightIds=new Map,this._updateHighlight=(0,h.Ds)((0,u.Z)(function*(){return t._proxy.setHighlight(Array.from(t._highlightIds.keys()))})),this._uploadsLocked=!1,this._needsClusterSizeUpdate=!1,this.featureEffectView=new P,this._lastDefinitionExpression=null}destroy(){this._updateClusterSizeTask?.remove(),this._proxy?.destroy(),this._commandsQueue.destroy()}initialize(){this.addResolvingPromise(Promise.all([this._initProxy(),this._initServiceOptions()])),this.addHandles([this.on("valueRangesChanged",t=>{this._set("_aggregateValueRanges",t.valueRanges)}),(0,f.YP)(()=>this.featureEffect,t=>{this.featureEffectView.featureEffect=t},f.tX)],"constructor"),this.featureEffectView.endTransitions()}_initProxy(){var t=this;return(0,u.Z)(function*(){const e=t.layer;if("isTable"in e&&e.isTable)throw new F.Z("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:t.layer});if(("feature"===e.type||"subtype-group"===e.type)&&!(0,k.S1)(e)?.operations.supportsQuery)throw new F.Z("featurelayerview:query-not-supported","layer view requires a layer with query capability",{layer:e});t._proxy&&t._proxy.destroy();const r=t._createClientOptions();return t._set("_proxy",new gt({client:r})),t._proxy.when()})()}_initServiceOptions(){var t=this;return(0,u.Z)(function*(){return t._set("_serviceOptions",yield t._createServiceOptions()),t._serviceOptions})()}get _effectiveFeatureReduction(){if(!("featureReduction"in this.layer))return null;const t=this.layer.featureReduction;return t&&(!("maxScale"in t)||!t.maxScale||t.maxScale<this.view.scale)?t:null}get orderByFields(){return"stream"!==this._serviceOptions?.type?this._serviceOptions?.orderByFields:void 0}get labelsVisible(){return!this.suspended&&("subtype-group"===this.layer.type?this.layer.sublayers.items:[this.layer]).some(e=>e.labelingInfo&&e.labelsVisible)}get labelingCollisionInfos(){const{tileRenderer:t,layer:e}=this;if(null==t)return null;const i=e.geometryType,s=!function Zt(t){for(const e of t){const i=[...e.labelingInfo||[],...("featureReduction"in e&&e.featureReduction&&"labelingInfo"in e.featureReduction?e.featureReduction:void 0)?.labelingInfo||[]];if(e.labelsVisible&&i.length&&i.some(s=>"none"===s.deconflictionStrategy))return!0}return!1}("subtype-group"===this.layer.type?this.layer.sublayers.items:[this.layer]),n={};if("subtype-group"!==e.type){if("heatmap"===t?.type)return null;const o=function zt(t){const e=null!=t&&"visualVariables"in t&&t.visualVariables;if(!e)return null;for(const r of e)if("size"===r.type)return Dt(r);return null}(e.renderer);n[0]=o}return[{tileRenderer:t,vvEvaluators:n,deconflictionEnabled:s,geometryType:i,visible:!this.suspended}]}get queryMode(){return this._serviceOptions?.type}get renderingConfigHash(){if(!this.layer)return null;const t=this.availableFields,e=this.layer,r=this.view.floors,{definitionExpression:i}=e,s="subtype-group"!==this.layer.type&&this.layer.labelsVisible&&this.layer.labelingInfo,n="renderer"in e&&e.renderer,o="gdbVersion"in e?e.gdbVersion:void 0,_="historicMoment"in e?e.historicMoment?.getTime():void 0,{timeExtent:y}=this,g="customParameters"in e?JSON.stringify(e.customParameters):void 0,v="apiKey"in e?e.apiKey:void 0,I="stream"===e.type?`${JSON.stringify(e.geometryDefinition)}${e.definitionExpression}`:null,S=JSON.stringify(this.clips),C=this._effectiveFeatureReduction?.toJSON(),j="orderBy"in this.layer&&JSON.stringify(this.layer.orderBy),G="sublayers"in this.layer&&this.layer.sublayers.items.reduce((de,K)=>de+`${K.visible?1:0}.${JSON.stringify(K.renderer)}.${K.labelsVisible}\n.${JSON.stringify(K.labelingInfo)}`,"");return JSON.stringify({orderBy:j,sublayerHash:G,subtypeCode:"subtypeCode"in this.layer&&this.layer.subtypeCode,filterHash:null!=this.filter&&this.filter.toJSON(),effectHash:null!=this.featureEffect&&this.featureEffect.toJSON(),streamFilter:I,gdbVersion:o,definitionExpression:i,historicMoment:_,availableFields:t,renderer:n,labelingInfo:s,timeExtent:y,floors:r,clipsHash:S,featureReduction:C,customParameters:g,apiKey:v,timeZone:this.view.timeZone})}highlight(t){let e;t instanceof b.Z?e=[t.getObjectId()]:"number"==typeof t||"string"==typeof t?e=[t]:A.Z.isCollection(t)&&t.length>0?e=t.map(i=>i?.getObjectId()).toArray():Array.isArray(t)&&t.length>0&&(e="number"==typeof t[0]||"string"==typeof t[0]?t:t.map(i=>i?.getObjectId()));const r=e?.filter(O.pC);return r?.length?(this._addHighlight(r),(0,q.kB)(()=>this._removeHighlight(r))):(0,q.kB)()}hasHighlight(){return!!this._highlightIds.size}hitTest(t,e){var r=this;return(0,u.Z)(function*(){if(!r.tileRenderer)return null;const i=yield r.tileRenderer.hitTest(e);if(0===i.length)return null;(0,m.Z)("featurelayer-force-marker-text-draw-order")&&i.sort((o,_)=>o-_);const{features:s,aggregates:n}=yield r._proxy.getFeatures(i);return[...n.map(o=>r._createGraphicHit(t,E.fromJSON(o))),...s.map(o=>r._createGraphicHit(t,b.Z.fromJSON(o)))]})()}queryStatistics(){return this._proxy.queryStatistics()}querySummaryStatistics(t,e,r){var i=this;return(0,u.Z)(function*(){const s={...e,scale:i.view.scale};return i._proxy.querySummaryStatistics(i._cleanUpQuery(t),s,r)})()}queryAggregateSummaryStatistics(t,e,r){var i=this;return(0,u.Z)(function*(){const s={...e,scale:i.view.scale};return i._proxy.queryAggregateSummaryStatistics(i._cleanUpAggregateQuery(t),s,r)})()}queryUniqueValues(t,e,r){var i=this;return(0,u.Z)(function*(){const s={...e,scale:i.view.scale};return i._proxy.queryUniqueValues(i._cleanUpQuery(t),s,r)})()}queryAggregateUniqueValues(t,e,r){var i=this;return(0,u.Z)(function*(){const s={...e,scale:i.view.scale};return i._proxy.queryAggregateUniqueValues(i._cleanUpAggregateQuery(t),s,r)})()}queryClassBreaks(t,e,r){var i=this;return(0,u.Z)(function*(){const s={...e,scale:i.view.scale};return i._proxy.queryClassBreaks(i._cleanUpQuery(t),s,r)})()}queryAggregateClassBreaks(t,e,r){var i=this;return(0,u.Z)(function*(){const s={...e,scale:i.view.scale};return i._proxy.queryAggregateClassBreaks(i._cleanUpAggregateQuery(t),s,r)})()}queryHistogram(t,e,r){var i=this;return(0,u.Z)(function*(){const s={...e,scale:i.view.scale};return i._proxy.queryHistogram(i._cleanUpQuery(t),s,r)})()}queryAggregateHistogram(t,e,r){var i=this;return(0,u.Z)(function*(){const s={...e,scale:i.view.scale};return i._proxy.queryAggregateHistogram(i._cleanUpAggregateQuery(t),s,r)})()}queryFeatures(t,e){return this.queryFeaturesJSON(t,e).then(r=>{const i=ce.Z.fromJSON(r);return i.features.forEach(s=>this._setLayersForFeature(s)),i})}queryVisibleFeatures(t,e){return this._proxy.queryVisibleFeatures(this._cleanUpQuery(t),e).then(r=>{const i=ce.Z.fromJSON(r);return i.features.forEach(s=>this._setLayersForFeature(s)),i})}queryAggregates(t,e){var r=this;return(0,u.Z)(function*(){const i=yield r._proxy.queryAggregates(r._cleanUpAggregateQuery(t),e),s=De.fromJSON(i);return s.features.forEach(n=>r._setLayersForFeature(n)),s})()}queryAggregateIds(t,e){return this._proxy.queryAggregateIds(this._cleanUpAggregateQuery(t),e)}queryAggregateCount(t,e){return this._proxy.queryAggregateCount(this._cleanUpAggregateQuery(t),e)}queryAggregateJSON(t,e){return this._proxy.queryAggregates(this._cleanUpAggregateQuery(t),e)}queryFeaturesJSON(t,e){return this._proxy.queryFeatures(this._cleanUpQuery(t),e)}queryObjectIds(t,e){return this._proxy.queryObjectIds(this._cleanUpQuery(t),e)}queryFeatureCount(t,e){return this._proxy.queryFeatureCount(this._cleanUpQuery(t),e)}queryExtent(t,e){return this._proxy.queryExtent(this._cleanUpQuery(t),e).then(r=>({count:r.count,extent:Mt.Z.fromJSON(r.extent)}))}setVisibility(t,e){e?this._visibilityOverrides.delete(t):this._visibilityOverrides.add(t),this._update()}update(t){if(!this._tileStrategy||!this.tileRenderer)return;const{hasMissingTiles:e,added:r,removed:i}=this._tileStrategy.update(t);(r.length||i.length)&&this._proxy.updateTiles({added:r,removed:i}),e&&this.requestUpdate(),this.notifyChange("updating")}attach(){this.view.timeline.record(`${this.layer.title} (FeatureLayer) Attach`),this._tileStrategy=new Ut({acquireTile:t=>this._acquireTile(t),releaseTile:t=>this._releaseTile(t),tileInfoView:this.view.featuresTilingScheme,buffer:0}),this.addAttachHandles((0,f.YP)(()=>this.renderingConfigHash,()=>this._update(),f.nn)),"stream"!==this.layer.type&&this.addAttachHandles(this.layer.on("edits",t=>this._edit(t)))}detach(){this._commandsQueue.clear(),this._proxy?.stop(),this.container.removeAllChildren(),this.tileRenderer?.uninstall(this.container),this.tileRenderer=null,this._tileStrategy=(0,l.SC)(this._tileStrategy),this._tileRendererHash=null}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}isUpdating(){const t="renderer"in this.layer&&null!=this.layer.renderer,e=this._commandsQueue.updating,r=null!=this._updatingRequiredFieldsPromise,i=!this._proxy||!this._proxy.isReady,s=this._pipelineIsUpdating,n=null==this.tileRenderer||this.tileRenderer?.updating,o=t&&(e||r||i||s||this.dataUpdating||n);return(0,m.Z)("esri-2d-log-updating")&&console.log(`Updating FLV2D (${this.layer.id}): ${o}\n  -> hasRenderer ${t}\n  -> hasPendingCommand ${e}\n  -> updatingRequiredFields ${r}\n  -> updatingProxy ${i}\n  -> updatingPipeline ${s}\n  -> updatingData: ${this.dataUpdating}\n  -> updatingTileRenderer ${n}\n`),o}_createClientOptions(){return{setUpdating:t=>{this._set("_pipelineIsUpdating",t)},setDataUpdating:t=>{this._set("dataUpdating",t)},emitEvent:t=>{this.emit(t.name,t.event)}}}_detectQueryMode(t){var e=this;return(0,u.Z)(function*(){const r="path"in t,{layer:i}=e,o=!("editingInfo"in i&&i.editingInfo?.lastEditDate)&&"refreshInterval"in i&&!!i.refreshInterval,_=(0,k.S1)(i);if(r&&("feature"===i.type||"subtype-group"===i.type)&&"point"===i.geometryType&&_?.query.supportsPagination&&!_?.operations.supportsEditing&&!o&&(0,m.Z)("featurelayer-snapshot-enabled"))try{const y=yield i.queryFeatureCount();if(y<=(0,m.Z)("featurelayer-snapshot-point-min-threshold"))return{mode:"snapshot",featureCount:y};const g=(0,m.Z)("featurelayer-snapshot-point-max-threshold"),v=(0,m.Z)("featurelayer-snapshot-point-coverage"),I=e.view.extent,S=i.fullExtent,C=S?.clone().intersection(I),G=S?.width*S?.height;if(y<=g&&(0===G?0:(null!=C?C.width*C.height:0)/G)>=v)return{mode:"snapshot",featureCount:y}}catch(y){R.Z.getLogger(e).warn("mapview-feature-layer","Encountered an error when querying for featureCount",{error:y})}return{mode:"on-demand"}})()}_createServiceOptions(){var t=this;return(0,u.Z)(function*(){const e=t.layer;if("stream"===e.type)return null;const r=(0,k.S1)(e),{capabilities:i,objectIdField:s}=e,n=e.fieldsIndex.toJSON(),o=n.fields,_=null!=e.fullExtent?e.fullExtent.toJSON():null,y=function qt(t){switch(t.geometryType){case"point":return"esriGeometryPoint";case"polyline":return"esriGeometryPolyline";case"polygon":case"multipatch":return"esriGeometryPolygon";case"multipoint":return"esriGeometryMultipoint";default:return R.Z.getLogger(Me).error(new F.Z("unsupported-geometry-type",`Geometry type of ${t.geometryType} is not supported`)),null}}(e),g="timeInfo"in e&&e.timeInfo?.toJSON()||null,v=e.spatialReference?e.spatialReference.toJSON():null,I="feature"===e.type?e.globalIdField:null;let S;"ogc-feature"===e.type?S=e.source.getSource():Le(e.source)?S=yield e.source.openPorts():e.parsedUrl&&(S=(0,H.d9)(e.parsedUrl),"dynamicDataSource"in e&&e.dynamicDataSource&&(S.query={layer:JSON.stringify({source:e.dynamicDataSource})}));const C="datesInUnknownTimezone"in t.layer&&t.layer.datesInUnknownTimezone,j=("subtypeField"in t.layer?t.layer.subtypeField:null)??null,{mode:G,featureCount:ee}=yield t._detectQueryMode(S);let de=t.layer.objectIdField;if("feature"===t.layer.type&&null!=t.layer.orderBy&&t.layer.orderBy.length){const K=!t.layer.orderBy[0].valueExpression&&t.layer.orderBy[0].field;K&&(de=K)}return{type:G,typeIdField:"typeIdField"in e&&e.typeIdField||void 0,types:"types"in e&&e.types?.map(K=>K.toJSON())||void 0,timeReferenceUnknownClient:C,subtypeField:j,featureCount:ee,globalIdField:I,maxRecordCount:i.query.maxRecordCount,tileMaxRecordCount:i.query.tileMaxRecordCount,capabilities:i,effectiveCapabilities:r,fields:o,fieldsIndex:n,fullExtent:_,geometryType:y,objectIdField:s,source:S,timeInfo:g,spatialReference:v,orderByFields:de}})()}_createMemoryServiceOptions(t){var e=this;return(0,u.Z)(function*(){const r=yield t.openPorts();return{...e._createServiceOptions(),type:"memory",source:r}})()}_cleanUpQuery(t){const e=ae.Z.from(t)||this.createQuery();return e.outSpatialReference||(e.outSpatialReference=this.view.spatialReference),e}_cleanUpAggregateQuery(t){const e=ae.Z.from(t)||this.createAggregateQuery();return e.outSpatialReference||(e.outSpatialReference=this.view.spatialReference),e}_update(){var t=this;return(0,u.Z)(function*(){return t._commandsQueue.push({type:"update"})})()}_edit(t){var e=this;return(0,u.Z)(function*(){return e.suspended?void e._clearTiles():e._validateEdit(t)?e._commandsQueue.push({type:"edit",edits:t}):void 0})()}doRefresh(t){var e=this;return(0,u.Z)(function*(){if(e.attached&&e._tileStrategy.tileKeys().length)return e.suspended&&t?void e._clearTiles():e._commandsQueue.push({type:"refresh",dataChanged:t})})()}_clearTiles(){this._tileStrategy.tileKeys().length&&(this._proxy.updateTiles({added:[],removed:this._tileStrategy.tileKeys()}),this._tileStrategy.clear(),this.requestUpdate(),this._commandsQueue.clear(),this._update())}_validateEdit(t){const e="globalIdField"in this.layer&&this.layer.globalIdField,r=t.deletedFeatures.some(s=>-1===s.objectId||!s.objectId),i=e&&this.availableFields.includes(e);return r&&!i?(R.Z.getLogger(this).error(new F.Z("mapview-apply-edits",`Editing the specified service requires the layer's globalIdField, ${e} to be included the layer's outFields for updates to be reflected on the map`)),null):t}_doUpdate(){var t=this;return(0,u.Z)(function*(){try{if(t.destroyed||!t._hasRequiredSupport(t.layer)||!t._tileStrategy)return;const{featureEffectView:e,filter:r}=t;if(yield t._updateRequiredFields(),t.destroyed)return;const{renderer:i}=t._getEffectiveRenderer();t._set("_effectiveRenderer",i);const s=t._createSchemaConfig(),n=t._createConfiguration(s,r,e.filter),o=t._lastDefinitionExpression!==n.schema.source.definitionExpression;t._lastDefinitionExpression=n.schema.source.definitionExpression;const _=n.schema.tileRenderer,y=t._createTileRendererHash(_);if("snapshot"===t._serviceOptions.type&&(n.schema.source.initialFeatureCount=t._serviceOptions.featureCount),y!==t._tileRendererHash){t._initTileRenderer(_,i);const g=t.layer,v="stream"===g.type?yield t._initServiceOptions():t._serviceOptions;t.tileRenderer.onConfigUpdate(i),"stream"!==g.type&&Le(g.source)&&(v.source=yield g.source.openPorts());const I={added:t._tileStrategy.tileKeys(),removed:[]};(0,m.Z)("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: Proxy startup"),yield t._proxy.startup(t.view.featuresTilingScheme,n,v,I),(0,m.Z)("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: Finished proxy startup"),t.hasHighlight()&&((0,m.Z)("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: Updating highlight"),yield t._proxy.setHighlight(Array.from(t._highlightIds.keys())),(0,m.Z)("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: Finished highlight update")),(0,m.Z)("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: onConfigUpdate start"),t.tileRenderer.onConfigUpdate(i),(0,m.Z)("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: onConfigUpdate end")}else{"snapshot"===t._serviceOptions.type&&o&&(n.schema.source.changedFeatureCount=yield t.layer.queryFeatureCount()),(0,m.Z)("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: Updating proxy");const g=yield t._proxy.update(n);(0,m.Z)("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: Finished proxy update"),(g.mesh||g.targets?.aggregate)&&((0,m.Z)("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: Locking GPU Uploads"),t._lockGPUUploads());try{(0,m.Z)("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: Applying update to proxy"),yield t._proxy.applyUpdate(g),(0,m.Z)("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: Finished applying update to proxy")}catch(v){(0,h.D_)(v)||R.Z.getLogger(t).error(v)}(g.mesh||g.targets?.aggregate)&&t._unlockGPUUploads(),t.tileRenderer.onConfigUpdate(i),t._updateClusterSizeVariable(),t._forceAttributeTextureUpload()}t._tileRendererHash=y,t.tileRenderer.invalidateLabels(),t.requestUpdate()}catch{}})()}_doEdit(t){var e=this;return(0,u.Z)(function*(){try{yield e._proxy.onEdits(t)}catch(r){(0,h.D_)(r)}})()}_doRefresh(t){var e=this;return(0,u.Z)(function*(){e._lockGPUUploads();try{let r;t&&"snapshot"===e.queryMode&&"queryFeatureCount"in e.layer&&(r=yield e.layer.queryFeatureCount()),yield e._proxy.refresh({dataChanged:t,featureCount:r})}catch(r){(0,h.D_)(r)}e._unlockGPUUploads(),e._effectiveFeatureReduction&&e._updateClusterSizeVariable()})()}_updateClusterSizeVariable(){this._needsClusterSizeUpdate&&(this.tileRenderer.onConfigUpdate(this._effectiveRenderer),this._needsClusterSizeUpdate=!1)}_createUpdateClusterSizeTask(t,e){return(0,f.YP)(()=>this._aggregateValueRanges,r=>{this._updateClusterEffectiveRendererSizeVariable(t,e,r),this._needsClusterSizeUpdate=!0,this._uploadsLocked||this._updateClusterSizeVariable()})}_updateClusterEffectiveRendererSizeVariable(t,e,r){var i=this;return(0,u.Z)(function*(){if(t.dynamicClusterSize&&"visualVariables"in t&&t.visualVariables){const s=(0,ie.os)(t.visualVariables);if(null!=s&&"cluster_count"===s.field){const n=t.visualVariables.indexOf(s);t.visualVariables[n]=(0,ie.aV)(e,r);const o=t.clone();o.dynamicClusterSize=!0,i._set("_effectiveRenderer",o)}}})()}_getEffectiveRenderer(){const t=this.layer,e="renderer"in t?t.renderer:null,r=this._effectiveFeatureReduction;if(this._updateClusterSizeTask=(0,l.hw)(this._updateClusterSizeTask),r&&"renderer"in r&&r.renderer&&!r.renderer.authoringInfo?.isAutoGenerated){const i=r.fields;if("cluster"===r.type){const{renderer:s,didInject:n}=(0,ie.st)(r.renderer,r,this._aggregateValueRanges);return n&&(this._updateClusterSizeTask=this._createUpdateClusterSizeTask(s,r)),{renderer:s,aggregateFields:i,featureReduction:r}}return{renderer:r.renderer,aggregateFields:i,featureReduction:r}}if(r&&"cluster"===r.type&&e&&(0,ie.yR)(e)){const i=r,s=[],n=(0,ie.S1)(s,e,i,this._aggregateValueRanges,!0);return this._updateClusterSizeTask=this._createUpdateClusterSizeTask(n,i),{renderer:n,aggregateFields:s,featureReduction:r}}return{renderer:e,aggregateFields:[],featureReduction:null}}_acquireTile(t){const e=this.tileRenderer.acquireTile(t);return e.once("attach",()=>{this.requestUpdate()}),e}_releaseTile(t){this.tileRenderer.releaseTile(t)}_initTileRenderer(t,e){const r=function dt(t,e){if(!t)return null;switch(t.type){case"symbol":return new _e(e);case"heatmap":return new fe(e)}}(t,{layerView:this,tileInfoView:this.view.featuresTilingScheme,layer:this.layer});return this.tileRenderer&&(this._tileStrategy.clear(),this.tileRenderer.uninstall(this.container),this.tileRenderer=(0,l.SC)(this.tileRenderer)),this.destroyed?null:(this._proxy.tileRenderer=r,this._set("tileRenderer",r),this.tileRenderer.install(this.container),this.tileRenderer.onConfigUpdate(e),this.requestUpdate(),this.tileRenderer)}_createTileRendererHash(t){return`${t.type}`}get hasFilter(){return!!(this.filter||"floorInfo"in this.layer&&this.layer.floorInfo&&this.view.floors&&this.view.floors.length||this._visibilityOverrides.size||this.timeExtent)}_injectOverrides(t){const e=null!=t?t.timeExtent:null,r=null!=this.timeExtent&&null!=e?this.timeExtent.intersection(e):this.timeExtent||e;let i=null;const s="floorInfo"in this.layer&&this.layer.floorInfo;if(s&&(i=this._addFloorFilterClause(null!=t?t.where:null)),!this._visibilityOverrides.size&&!r&&!s)return null!=t?t.toJSON():null;(t=null!=t&&t.clone()||new N.Z).timeExtent=r,i&&(t.where=i);const n=t.toJSON();return n.hiddenIds=Array.from(this._visibilityOverrides),n}_addFloorFilterClause(t){const e=this.layer;let r=t||"";if("floorInfo"in e&&e.floorInfo){let i=this.view.floors;if(!i?.length)return r;e.floorInfo.viewAllLevelIds?.length&&(i=e.floorInfo.viewAllLevelIds);const s=i.filter(_=>""!==_).map(_=>"'"+_+"'");s.push("''");const n=e.floorInfo.floorField;let o="("+n+" IN ({ids}) OR "+n+" IS NULL)";if(o=o.replace("{ids}",s.join(", ")),null!=r&&r.includes(n)){let _=new RegExp("AND \\("+n+".*NULL\\)","g");r=r.replace(_,""),_=new RegExp("\\("+n+".*NULL\\)","g"),r=r.replace(_,""),r=r.replaceAll(/\s+/g," ").trim()}r=""!==r?"("+r+") AND "+o:o}return""!==r?r:null}_createConfiguration(t,e,r){const i="feature"===this.layer.type&&this.layer.historicMoment?this.layer.historicMoment.getTime():void 0,s="feature"===this.layer.type?this.layer.gdbVersion??void 0:void 0,n=new Array(ze.NS),o=this._injectOverrides(e);n[0]=o,n[1]=null!=r?r.toJSON():null;const _=(0,ke.Ew)(t);if(null==_)return null;const y=(0,Lt.hc)("2d");return{availableFields:this.availableFields,gdbVersion:s,historicMoment:i,devicePixelRatio:window.devicePixelRatio||1,filters:n,schema:_,supportsTextureFloat:y.supportsTextureFloat,maxTextureSize:y.maxTextureSize,timeZone:this.view.timeZone}}_hasRequiredSupport(t){return!("renderer"in t)||(0,Ie.TT)(t.renderer)}_lockGPUUploads(){this.tileRenderer&&(this._uploadsLocked=!0,this.tileRenderer.lockGPUUploads())}_unlockGPUUploads(){this.tileRenderer&&(this._uploadsLocked=!1,this.tileRenderer.unlockGPUUploads())}_forceAttributeTextureUpload(){this.tileRenderer&&this.tileRenderer.forceAttributeTextureUpload()}_createSchemaConfig(){const t=this.layer;return{renderer:"renderer"in t?t.renderer:null,spatialReference:t.spatialReference,timeExtent:"timeExtent"in t?t.timeExtent:null,definitionExpression:t.definitionExpression,featureReduction:this._effectiveFeatureReduction,fields:t.fields,geometryType:t.geometryType,historicMoment:"historicMoment"in t?t.historicMoment:null,labelsVisible:"labelsVisible"in t&&t.labelsVisible,labelingInfo:"labelingInfo"in t?t.labelingInfo:null,availableFields:this.availableFields,featureEffect:this.featureEffect,filter:this.filter,gdbVersion:"gdbVersion"in t?t.gdbVersion:null,pixelBuffer:0,orderBy:"orderBy"in t&&t.orderBy?t.orderBy:null,customParameters:{..."customParameters"in t?t.customParameters:void 0,token:"apiKey"in t?t.apiKey??void 0:void 0},subtypeCode:"subtypeCode"in t?t.subtypeCode:void 0,subtypeField:"subtypeField"in t?t.subtypeField:void 0}}_addHighlight(t){for(const e of t)if(this._highlightIds.has(e)){const r=this._highlightIds.get(e);this._highlightIds.set(e,r+1)}else this._highlightIds.set(e,1);this._updateHighlight().catch(e=>{(0,h.D_)(e)||R.Z.getLogger(this).error(e)})}_removeHighlight(t){for(const e of t)if(this._highlightIds.has(e)){const r=this._highlightIds.get(e)-1;0===r?this._highlightIds.delete(e):this._highlightIds.set(e,r)}this._updateHighlight().catch(e=>{(0,h.D_)(e)||R.Z.getLogger(this).error(e)})}_setLayersForFeature(t){const e=this.layer;t.layer=e,t.sourceLayer=e}_createGraphicHit(t,e){return this._setLayersForFeature(e),null!=e.geometry&&(e.geometry.spatialReference=this.view.spatialReference),{type:"graphic",graphic:e,layer:this.layer,mapPoint:t}}};(0,d._)([(0,c.Cb)()],z.prototype,"_serviceOptions",void 0),(0,d._)([(0,c.Cb)()],z.prototype,"_proxy",void 0),(0,d._)([(0,c.Cb)()],z.prototype,"_pipelineIsUpdating",void 0),(0,d._)([(0,c.Cb)()],z.prototype,"_effectiveRenderer",void 0),(0,d._)([(0,c.Cb)()],z.prototype,"_effectiveFeatureReduction",null),(0,d._)([(0,c.Cb)()],z.prototype,"_aggregateValueRanges",void 0),(0,d._)([(0,c.Cb)()],z.prototype,"_commandsQueue",void 0),(0,d._)([(0,c.Cb)()],z.prototype,"featureEffectView",void 0),(0,d._)([(0,c.Cb)()],z.prototype,"labelsVisible",null),(0,d._)([(0,c.Cb)()],z.prototype,"labelingCollisionInfos",null),(0,d._)([(0,c.Cb)({readOnly:!0})],z.prototype,"queryMode",null),(0,d._)([(0,c.Cb)()],z.prototype,"renderingConfigHash",null),(0,d._)([(0,c.Cb)()],z.prototype,"tileRenderer",void 0),(0,d._)([(0,c.Cb)()],z.prototype,"updating",void 0),z=(0,d._)([(0,w.j)(Me)],z);const kt=z},94421:(W,L,a)=>{a.d(L,{Z:()=>E});var u=a(17626),d=a(63290),b=a(10699),c=a(32917),U=a(77712),p=(a(90912),a(85931),a(8314),a(76898));const E=x=>{let A=class extends x{initialize(){this.addHandles((0,c.on)(()=>this.layer,"refresh",F=>{this.doRefresh(F.dataChanged).catch(q=>{(0,b.D_)(q)||d.Z.getLogger(this).error(q)})}),"RefreshableLayerView")}};return(0,u._)([(0,U.Cb)()],A.prototype,"layer",void 0),A=(0,u._)([(0,p.j)("esri.layers.mixins.RefreshableLayerView")],A),A}},10023:(W,L,a)=>{a.d(L,{V5:()=>U,e7:()=>b});var u=a(15861),d=a(90194);function b(m){return c.apply(this,arguments)}function c(){return(c=(0,u.Z)(function*(m,w=m.popupTemplate){if(null==w)return[];const p=yield w.getRequiredFields(m.fieldsIndex),{lastEditInfoEnabled:E}=w,{objectIdField:x,typeIdField:A,globalIdField:F,relationships:q}=m;if(p.includes("*"))return["*"];const H=E?(0,d.CH)(m):[],R=(0,d.Q0)(m.fieldsIndex,[...p,...H]);return A&&R.push(A),R&&x&&m.fieldsIndex?.has(x)&&!R.includes(x)&&R.push(x),R&&F&&m.fieldsIndex?.has(F)&&!R.includes(F)&&R.push(F),q&&q.forEach(l=>{const{keyField:h}=l;R&&h&&m.fieldsIndex?.has(h)&&!R.includes(h)&&R.push(h)}),R})).apply(this,arguments)}function U(m,w){return m.popupTemplate?m.popupTemplate:null!=w&&w.defaultPopupTemplateEnabled&&null!=m.defaultPopupTemplate?m.defaultPopupTemplate:null}}}]);